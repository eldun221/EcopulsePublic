{% extends "base.html" %}

{% block title %}Админ панель - ЭКОПУЛЬС{% endblock %}

{% block content %}

<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-cog"></i> Административная панель</h1>
        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-value">{{ requests|length }}</div>
                <div class="stat-label">Ожидают рассмотрения</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ zones|length }}</div>
                <div class="stat-label">Всего зон</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ user_count }}</div>
                <div class="stat-label">Пользователей</div>
            </div>
            <div class="stat-card">
                <button class="btn btn-primary" id="open-add-zone-modal">
                    <i class="fas fa-plus-circle"></i> Добавить зону
                </button>
            </div>
        </div>

        <!-- Отображение текущей роли -->
        <div class="current-role-badge">
            <span class="role-badge role-{{ user.role }}">
                {% if user.role == 'super_admin' %}
                    <i class="fas fa-crown"></i> Главный администратор
                {% elif user.role == 'junior_admin' %}
                    <i class="fas fa-user-shield"></i> Младший администратор
                {% elif user.role == 'moderator' %}
                    <i class="fas fa-user-check"></i> Модератор
                {% endif %}
            </span>
        </div>
    </div>

    <div class="admin-tabs">
        <button class="tab-btn active" data-tab="requests">Заявки на добавление зон</button>
        <button class="tab-btn" data-tab="zones">Все зоны</button>
        <button class="tab-btn" data-tab="users">Пользователи</button>
        <button class="tab-btn" data-tab="reports">Отчёты</button>
        <button class="tab-btn" data-tab="dictionaries">Справочники</button>
    </div>

    <!-- Таб заявок -->
    <div class="tab-content active" id="requests-tab">
        {% if requests %}
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Город</th>
                        <th>Тип</th>
                        <th>Пользователь</th>
                        <th>Дата</th>
                        <th class="actions-column">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in requests %}
                    <tr>
                        <td>{{ request.id }}</td>
                        <td>
                            <strong>{{ request.name }}</strong><br>
                            <small>{{ request.description[:50] }}...</small>
                        </td>
                        <td>{{ request.city }}</td>
                        <td>{{ request.type }}</td>
                        <td>
                            {{ request.user_name }}<br>
                            <small>{{ request.user_email }}</small>
                        </td>
                        <td>{{ request.created_at[:10] }}</td>
                        <td class="actions">
                            <button class="btn-view action-btn" onclick="viewRequestDetails({{ request.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-approve action-btn" onclick="approveRequest({{ request.id }})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-reject action-btn" onclick="rejectRequest({{ request.id }})">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>Нет заявок на рассмотрение</h3>
            <p>Все заявки обработаны</p>
        </div>
        {% endif %}
    </div>

    <!-- Таб всех зон -->
    <div class="tab-content" id="zones-tab">
        <div class="table-controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="zone-search" placeholder="Поиск зон...">
            </div>
            <select id="city-filter">
                <option value="">Все города</option>
                {% for city in cities.keys() %}
                <option value="{{ city }}">{{ city }}</option>
                {% endfor %}
            </select>
            <select id="status-filter">
                <option value="">Все статусы</option>
                {% for status in statuses.keys() %}
                <option value="{{ status }}">{{ status|capitalize }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Город</th>
                        <th>Тип</th>
                        <th>Статус</th>
                        <th>Создатель</th>
                        <th>Дата создания</th>
                        <th class="actions-column">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for zone in zones %}
                    <tr id="zone-row-{{ zone.id }}">
                        <td>{{ zone.id }}</td>
                        <td>
                            <strong>{{ zone.name }}</strong><br>
                            <small>{{ zone.description[:50] }}...</small>
                        </td>
                        <td>{{ zone.city }}</td>
                        <td>{{ zone.type }}</td>
                        <td>
                            <span class="status-badge" style="background-color: {{ statuses[zone.status].color }}">
                                {{ zone.status }}
                            </span>
                        </td>
                        <td>{{ zone.creator_name }}</td>
                        <td>
                            {% if zone.created_at %}
                                {{ zone.created_at[:10] }}
                            {% else %}
                                Не указана
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            <div class="actions-inline">
                                <button class="btn-view action-btn" onclick="viewZoneOnMap({{ zone.id }})" title="Посмотреть на карте">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-edit action-btn" onclick="editZone({{ zone.id }})" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if user.role in ['super_admin', 'junior_admin'] %}
                                <button class="btn-delete action-btn" onclick="deleteZone({{ zone.id }})" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Таб пользователей -->
    <div class="tab-content" id="users-tab">
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Имя</th>
                        <th>Email</th>
                        <th>Роль</th>
                        <th>Город</th>
                        <th>Дата регистрации</th>
                        <th class="actions-column">Действия</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    <!-- Данные загружаются через AJAX -->
                    <tr>
                        <td colspan="7" class="loading-cell">
                            <i class="fas fa-spinner fa-spin"></i> Загрузка пользователей...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Таб отчётов -->
    <div class="tab-content" id="reports-tab">
        <div class="reports-grid">
            <div class="report-card">
                <h3><i class="fas fa-chart-line"></i> Статистика системы</h3>
                <div id="system-stats"></div>
                <button class="btn btn-outline" onclick="generateSystemReport()" style="display: block; margin: 0 auto;">
                    <i class="fas fa-download"></i> Скачать отчет
                </button>
            </div>

            <div class="report-card">
                <h3><i class="fas fa-exclamation-triangle"></i> Активные проблемы</h3>
                <div id="active-problems"></div>
            </div>

            <div class="report-card">
                <h3><i class="fas fa-tools"></i> Работы по обслуживанию</h3>
                <div id="maintenance-stats"></div>
            </div>

            <div class="report-card">
                <h3><i class="fas fa-city"></i> Статистика по городам</h3>
                <div id="city-stats"></div>
            </div>
        </div>
    </div>

    <!-- Таб справочников -->
    <div class="tab-content" id="dictionaries-tab">
        <div class="dictionaries-controls">
            <button class="btn btn-outline active-dict" data-dict="cities">
                <i class="fas fa-city"></i> Города
            </button>
            <button class="btn btn-outline" data-dict="zone_types">
                <i class="fas fa-tree"></i> Типы зон
            </button>
            <button class="btn btn-outline" data-dict="statuses">
                <i class="fas fa-tag"></i> Статусы
            </button>
            <button class="btn btn-outline" data-dict="problem_types">
                <i class="fas fa-exclamation-triangle"></i> Типы проблем
            </button>
        </div>

        <div class="dictionary-content" id="dictionary-content">
            <div class="empty-state">
                <i class="fas fa-book"></i>
                <h3>Выберите справочник</h3>
                <p>Нажмите на кнопку выше для выбора справочника</p>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления зоны админом -->
<!-- Модальное окно добавления зоны админом -->
<div id="add-zone-admin-modal" class="modal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Добавить новую зону (админ)</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="add-zone-admin-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="admin-zone-name">Название зоны *</label>
                        <input type="text" id="admin-zone-name" required
                               placeholder="Например: Парк Победы" class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="admin-zone-city">Город *</label>
                        <select id="admin-zone-city" required class="admin-form-input">
                            <option value="">Выберите город</option>
                            {% for city_name in cities.keys()|sort %}
                            <option value="{{ city_name }}">{{ city_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="admin-zone-type">Тип зоны *</label>
                        <select id="admin-zone-type" required class="admin-form-input">
                            <option value="">Выберите тип</option>
                            {% for type in zone_types %}
                            <option value="{{ type }}">{{ type|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="admin-zone-status">Статус *</label>
                        <select id="admin-zone-status" required class="admin-form-input">
                            {% for status in statuses.keys() %}
                            <option value="{{ status }}">{{ status|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="admin-zone-lat">Широта *</label>
                        <input type="text" id="admin-zone-lat" required
                               placeholder="53.347996"
                               pattern="^-?\d+(\.\d+)?$"
                               title="Только цифры и точка" class="admin-form-input">
                        <small class="hint">Используйте точные координаты из карт</small>
                    </div>
                    <div class="form-group">
                        <label for="admin-zone-lng">Долгота *</label>
                        <input type="text" id="admin-zone-lng" required
                               placeholder="83.779836"
                               pattern="^-?\d+(\.\d+)?$"
                               title="Только цифры и точка" class="admin-form-input">
                        <small class="hint">Пример: 83.779836 для Барнаула</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="admin-zone-description">Описание *</label>
                    <textarea id="admin-zone-description" rows="4" required
                              placeholder="Подробное описание зоны..." class="admin-form-input"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="pickLocationOnMap()">
                        <i class="fas fa-map-marker-alt"></i> Выбрать на карте
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Сохранить зону
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования зоны -->
<div id="edit-zone-modal" class="modal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Редактирование зоны</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body" id="edit-zone-form-container">
            <!-- Форма редактирования загружается через JS -->
        </div>
    </div>
</div>

<!-- Модальное окно назначения младшим администратором -->
<div id="promote-junior-admin-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-shield"></i> Назначение младшего администратора</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="promote-junior-admin-form">
                <div class="form-group">
                    <label>Пользователь</label>
                    <input type="text" id="promote-junior-user-name" readonly class="admin-form-input">
                </div>
                <div class="form-group">
                    <label for="super-admin-password">Пароль супер-администратора *</label>
                    <input type="password" id="super-admin-password" required
                           placeholder="Введите ваш пароль для подтверждения" class="admin-form-input">
                </div>
                <input type="hidden" id="promote-junior-user-id">
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Назначить младшим администратором
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно назначения модератора -->
<div id="promote-moderator-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-check"></i> Назначение модератора</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="promote-moderator-form">
                <div class="form-group">
                    <label>Пользователь</label>
                    <input type="text" id="promote-user-name" readonly class="admin-form-input">
                </div>
                {% if user.role == 'super_admin' %}
                <div class="form-group">
                    <label for="admin-password">Пароль администратора *</label>
                    <input type="password" id="admin-password" required
                           placeholder="Введите ваш пароль для подтверждения" class="admin-form-input">
                </div>
                {% endif %}
                <input type="hidden" id="promote-user-id">
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Назначить модератором
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно понижения пользователя -->
<div id="demote-user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-minus"></i> Понижение пользователя</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="demote-user-form">
                <div class="form-group">
                    <label>Пользователь</label>
                    <input type="text" id="demote-user-name" readonly class="admin-form-input">
                </div>
                <div class="form-group">
                    <label for="confirm-demote">Подтверждение</label>
                    <select id="confirm-demote" class="admin-form-input" required>
                        <option value="">Выберите действие</option>
                        <option value="demote">Понизить до обычного пользователя</option>
                        {% if user.role == 'super_admin' %}
                        <option value="delete">Удалить пользователя</option>
                        {% endif %}
                    </select>
                </div>
                {% if user.role == 'super_admin' %}
                <div class="form-group" id="admin-password-group" style="display: none;">
                    <label for="delete-admin-password">Пароль супер-администратора *</label>
                    <input type="password" id="delete-admin-password"
                           placeholder="Введите ваш пароль для подтверждения" class="admin-form-input">
                </div>
                {% endif %}
                <input type="hidden" id="demote-user-id">
                <input type="hidden" id="demote-user-role">
                <div class="form-actions">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> Подтвердить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно просмотра заявки -->
<div id="request-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Детали заявки</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body" id="request-details"></div>
    </div>
</div>

<!-- Модальное окно управления справочником -->
<div id="dictionary-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="dictionary-modal-title">Редактирование элемента</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body" id="dictionary-modal-content">
            <!-- Форма редактирования загружается через JS -->
        </div>
    </div>
</div>

<!-- Глобальные переменные для передачи данных из шаблона в JS -->
<script>
    // Передаем данные из шаблона в глобальную область видимости
    window.templateData = {
        user: {{ user|tojson }},
        cities: {{ cities|tojson }},
        zone_types: {{ zone_types|tojson }},
        statuses: {{ statuses|tojson }}
    };
</script>

<!-- Подключение внешнего JS файла -->
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}