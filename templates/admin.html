{% extends "base.html" %}

{% block title %}Админ панель - ЭКОПУЛЬС{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-cog"></i> Административная панель</h1>
        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-value">{{ requests|length }}</div>
                <div class="stat-label">Ожидают рассмотрения</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ zones|length }}</div>
                <div class="stat-label">Всего зон</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ user_count }}</div>
                <div class="stat-label">Пользователей</div>
            </div>
            <div class="stat-card">
                <button class="btn btn-primary" id="open-add-zone-modal">
                    <i class="fas fa-plus-circle"></i> Добавить зону
                </button>
            </div>
        </div>

        <!-- Отображение текущей роли -->
        <div class="current-role-badge">
            <span class="role-badge role-{{ user.role }}">
                {% if user.role == 'super_admin' %}
                    <i class="fas fa-crown"></i> Главный администратор
                {% elif user.role == 'junior_admin' %}
                    <i class="fas fa-user-shield"></i> Младший администратор
                {% elif user.role == 'moderator' %}
                    <i class="fas fa-user-check"></i> Модератор
                {% endif %}
            </span>
        </div>
    </div>

    <div class="admin-tabs">
        <button class="tab-btn active" data-tab="requests">Заявки на добавление зон</button>
        <button class="tab-btn" data-tab="zones">Все зоны</button>
        <button class="tab-btn" data-tab="users">Пользователи</button>
        <button class="tab-btn" data-tab="reports">Отчёты</button>
        <button class="tab-btn" data-tab="dictionaries">Справочники</button>
    </div>

    <!-- Таб заявок -->
    <div class="tab-content active" id="requests-tab">
        {% if requests %}
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Город</th>
                        <th>Тип</th>
                        <th>Пользователь</th>
                        <th>Дата</th>
                        <th class="actions-column">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in requests %}
                    <tr>
                        <td>{{ request.id }}</td>
                        <td>
                            <strong>{{ request.name }}</strong><br>
                            <small>{{ request.description[:50] }}...</small>
                        </td>
                        <td>{{ request.city }}</td>
                        <td>{{ request.type }}</td>
                        <td>
                            {{ request.user_name }}<br>
                            <small>{{ request.user_email }}</small>
                        </td>
                        <td>{{ request.created_at[:10] }}</td>
                        <td class="actions">
                            <button class="btn-view" onclick="viewRequestDetails({{ request.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-approve" onclick="approveRequest({{ request.id }})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-reject" onclick="rejectRequest({{ request.id }})">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>Нет заявок на рассмотрение</h3>
            <p>Все заявки обработаны</p>
        </div>
        {% endif %}
    </div>

    <!-- Таб всех зон -->
    <div class="tab-content" id="zones-tab">
        <div class="table-controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="zone-search" placeholder="Поиск зон...">
            </div>
            <select id="city-filter">
                <option value="">Все города</option>
                {% for city in cities.keys() %}
                <option value="{{ city }}">{{ city }}</option>
                {% endfor %}
            </select>
            <select id="status-filter">
                <option value="">Все статусы</option>
                {% for status in statuses.keys() %}
                <option value="{{ status }}">{{ status|capitalize }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Город</th>
                        <th>Тип</th>
                        <th>Статус</th>
                        <th>Создатель</th>
                        <th>Дата создания</th>
                        <th class="actions-column">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for zone in zones %}
                        <tr id="zone-row-{{ zone.id }}">
                            <td>{{ zone.id }}</td>
                            <td>
                                <strong>{{ zone.name }}</strong><br>
                                <small>{{ zone.description[:50] }}...</small>
                            </td>
                            <td>{{ zone.city }}</td>
                            <td>{{ zone.type }}</td>
                            <td>
                                <span class="status-badge" style="background-color: {{ statuses[zone.status].color }}">
                                    {{ zone.status }}
                                </span>
                            </td>
                            <td>{{ zone.creator_name }}</td>
                            <td>{{ zone.created_at[:10] }}</td>
                            <td class="actions">
                                <button class="btn-view" onclick="viewZoneDetails({{ zone.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-edit" onclick="editZone({{ zone.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if user.role in ['super_admin', 'junior_admin'] %}
                                <button class="btn-delete" onclick="deleteZone({{ zone.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Таб пользователей -->
    <div class="tab-content" id="users-tab">
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Имя</th>
                        <th>Email</th>
                        <th>Роль</th>
                        <th>Город</th>
                        <th>Дата регистрации</th>
                        <th class="actions-column">Действия</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    <!-- Данные загружаются через AJAX -->
                    <tr>
                        <td colspan="7" class="loading-cell">
                            <i class="fas fa-spinner fa-spin"></i> Загрузка пользователей...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Таб отчётов -->
    <div class="tab-content" id="reports-tab">
        <div class="reports-grid">
            <div class="report-card">
                <h3><i class="fas fa-chart-line"></i> Статистика системы</h3>
                <div id="system-stats"></div>
                <button class="btn btn-outline" onclick="generateSystemReport()" style="display: block; margin: 0 auto;">
                    <i class="fas fa-download"></i> Скачать отчет
                </button>
            </div>

            <div class="report-card">
                <h3><i class="fas fa-exclamation-triangle"></i> Активные проблемы</h3>
                <div id="active-problems"></div>
            </div>

            <div class="report-card">
                <h3><i class="fas fa-tools"></i> Работы по обслуживанию</h3>
                <div id="maintenance-stats"></div>
            </div>

            <div class="report-card">
                <h3><i class="fas fa-city"></i> Статистика по городам</h3>
                <div id="city-stats"></div>
            </div>
        </div>
    </div>

    <!-- Таб справочников -->
    <div class="tab-content" id="dictionaries-tab">
        <div class="dictionaries-controls">
            <button class="btn btn-outline active-dict" data-dict="cities">
                <i class="fas fa-city"></i> Города
            </button>
            <button class="btn btn-outline" data-dict="zone_types">
                <i class="fas fa-tree"></i> Типы зон
            </button>
            <button class="btn btn-outline" data-dict="statuses">
                <i class="fas fa-tag"></i> Статусы
            </button>
            <button class="btn btn-outline" data-dict="problem_types">
                <i class="fas fa-exclamation-triangle"></i> Типы проблем
            </button>
        </div>

        <div class="dictionary-content" id="dictionary-content">
            <div class="empty-state">
                <i class="fas fa-book"></i>
                <h3>Выберите справочник</h3>
                <p>Нажмите на кнопку выше для выбора справочника</p>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления зоны админом -->
<div id="add-zone-admin-modal" class="modal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Добавить новую зону (админ)</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="add-zone-admin-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="admin-zone-name">Название зоны *</label>
                        <input type="text" id="admin-zone-name" required
                               placeholder="Например: Парк Победы" class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="admin-zone-city">Город *</label>
                        <select id="admin-zone-city" required class="admin-form-input">
                            <option value="">Выберите город</option>
                            {% for city_name in cities.keys()|sort %}
                            <option value="{{ city_name }}">{{ city_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="admin-zone-type">Тип зоны *</label>
                        <select id="admin-zone-type" required class="admin-form-input">
                            <option value="">Выберите тип</option>
                            {% for type in zone_types %}
                            <option value="{{ type }}">{{ type|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="admin-zone-status">Статус *</label>
                        <select id="admin-zone-status" required class="admin-form-input">
                            {% for status in statuses.keys() %}
                            <option value="{{ status }}">{{ status|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="admin-zone-lat">Широта *</label>
                        <input type="text" id="admin-zone-lat" required
                               placeholder="53.347996"
                               pattern="^-?\d+(\.\d+)?$"
                               title="Только цифры и точка" class="admin-form-input">
                        <small class="hint">Используйте точные координаты из карт</small>
                    </div>
                    <div class="form-group">
                        <label for="admin-zone-lng">Долгота *</label>
                        <input type="text" id="admin-zone-lng" required
                               placeholder="83.779836"
                               pattern="^-?\d+(\.\d+)?$"
                               title="Только цифры и точка" class="admin-form-input">
                        <small class="hint">Пример: 83.779836 для Барнаула</small>
                    </div>
                </div>


                <!--
                <div class="form-row">
                    <div class="form-group">
                        <label for="admin-zone-area">Площадь</label>
                        <div class="area-input-group">
                            <input type="text" id="admin-zone-area"
                                   placeholder="Например: 5" class="admin-form-input">
                            <select id="admin-zone-area-unit" class="admin-form-input">
                                <option value="га">га</option>
                                <option value="м²">м²</option>
                            </select>
                        </div>
                    </div>
                </div>
                -->

                <div class="form-group">
                    <label for="admin-zone-description">Описание *</label>
                    <textarea id="admin-zone-description" rows="4" required
                              placeholder="Подробное описание зоны..." class="admin-form-input"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="pickLocationOnMap()">
                        <i class="fas fa-map-marker-alt"></i> Выбрать на карте
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Сохранить зону
                    </button>
                </div>

                <div class="form-notice">
                    <p><i class="fas fa-info-circle"></i> Зона будет добавлена сразу без модерации</p>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования зоны -->
<div id="edit-zone-modal" class="modal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Редактирование зоны</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body" id="edit-zone-form-container">
            <!-- Форма редактирования загружается через JS -->
        </div>
    </div>
</div>

<!-- Модальное окно назначения младшим администратором -->
<div id="promote-junior-admin-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-shield"></i> Назначение младшего администратора</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="promote-junior-admin-form">
                <div class="form-group">
                    <label>Пользователь</label>
                    <input type="text" id="promote-junior-user-name" readonly class="admin-form-input">
                </div>
                <div class="form-group">
                    <label for="super-admin-password">Пароль супер-администратора *</label>
                    <input type="password" id="super-admin-password" required
                           placeholder="Введите ваш пароль для подтверждения" class="admin-form-input">
                </div>
                <input type="hidden" id="promote-junior-user-id">
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Назначить младшим администратором
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно назначения модератора -->
<div id="promote-moderator-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-check"></i> Назначение модератора</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="promote-moderator-form">
                <div class="form-group">
                    <label>Пользователь</label>
                    <input type="text" id="promote-user-name" readonly class="admin-form-input">
                </div>
                {% if user.role == 'super_admin' %}
                <div class="form-group">
                    <label for="admin-password">Пароль администратора *</label>
                    <input type="password" id="admin-password" required
                           placeholder="Введите ваш пароль для подтверждения" class="admin-form-input">
                </div>
                {% endif %}
                <input type="hidden" id="promote-user-id">
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Назначить модератором
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно понижения пользователя -->
<div id="demote-user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-minus"></i> Понижение пользователя</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="demote-user-form">
                <div class="form-group">
                    <label>Пользователь</label>
                    <input type="text" id="demote-user-name" readonly class="admin-form-input">
                </div>
                <div class="form-group">
                    <label for="confirm-demote">Подтверждение</label>
                    <select id="confirm-demote" class="admin-form-input" required>
                        <option value="">Выберите действие</option>
                        <option value="demote">Понизить до обычного пользователя</option>
                        {% if user.role == 'super_admin' %}
                        <option value="delete">Удалить пользователя</option>
                        {% endif %}
                    </select>
                </div>
                {% if user.role == 'super_admin' %}
                <div class="form-group" id="admin-password-group" style="display: none;">
                    <label for="delete-admin-password">Пароль супер-администратора *</label>
                    <input type="password" id="delete-admin-password"
                           placeholder="Введите ваш пароль для подтверждения" class="admin-form-input">
                </div>
                {% endif %}
                <input type="hidden" id="demote-user-id">
                <input type="hidden" id="demote-user-role">
                <div class="form-actions">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> Подтвердить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно просмотра заявки -->
<div id="request-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Детали заявки</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body" id="request-details"></div>
    </div>
</div>

<!-- Модальное окно управления справочником -->
<div id="dictionary-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="dictionary-modal-title">Редактирование элемента</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body" id="dictionary-modal-content">
            <!-- Форма редактирования загружается через JS -->
        </div>
    </div>
</div>

<style>
.admin-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.admin-header {
    margin-bottom: 2rem;
    position: relative;
}

.admin-header h1 {
    color: var(--primary-dark);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.current-role-badge {
    position: absolute;
    top: 0;
    right: 0;
}

.role-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.role-super_admin {
    background: linear-gradient(135deg, #ffd700, #ffa500);
    color: #333;
    border: 2px solid #ffa500;
}

.role-junior_admin {
    background: linear-gradient(135deg, #4caf50, #2e7d32);
    color: white;
    border: 2px solid #2e7d32;
}

.role-moderator {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    color: white;
    border: 2px solid #1976d32;
}

.admin-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.stat-card:last-child {
    justify-content: center;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.admin-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 0.5rem;
    flex-wrap: wrap;
}

.tab-btn {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    font-size: 1rem;
    color: var(--text-secondary);
    position: relative;
    transition: all 0.3s;
    white-space: nowrap;
}

.tab-btn:hover {
    background: #f5f5f5;
    color: var(--primary-color);
}

.tab-btn.active {
    color: var(--primary-color);
    font-weight: 600;
}

.tab-btn.active:after {
    content: '';
    position: absolute;
    bottom: -0.5rem;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.table-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.search-box {
    flex: 1;
    position: relative;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
}

.search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border: 1px solid #ddd;
    border-radius: 6px;
}

.table-controls select {
    padding: 0.75rem 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    min-width: 150px;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}

.admin-table th {
    background: #f5f5f5;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid #e0e0e0;
}

.admin-table td {
    padding: 1rem;
    border-bottom: 1px solid #e0e0e0;
    vertical-align: top;
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
}

.admin-table tr:hover {
    background: #f9f9f9;
}

.actions-column {
    width: 180px;
    min-width: 180px;
}

.actions {
    display: flex;
    gap: 0.25rem;
    justify-content: center;
    align-items: center;
    min-height: 60px;
    flex-wrap: wrap;
}

.actions button {
    min-width: 32px;
    height: 32px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 0.9rem;
    padding: 0;
}

#users-tbody .actions {
    min-height: 60px;
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    justify-content: center;
    align-items: center;
}

.role-badge-cell {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-block;
    text-align: center;
}

.role-badge-super_admin {
    background: linear-gradient(135deg, #ffd700, #ffa500);
    color: #333;
}

.role-badge-junior_admin {
    background: linear-gradient(135deg, #4caf50, #2e7d32);
    color: white;
}

.role-badge-moderator {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    color: white;
}

.role-badge-user {
    background: #f5f5f5;
    color: #666;
}

.btn-view {
    background: #e3f2fd;
    color: #1976d2;
}

.btn-view:hover {
    background: #bbdefb;
}

.btn-approve {
    background: #e8f5e9;
    color: #4caf50;
}

.btn-approve:hover {
    background: #c8e6c9;
}

.btn-reject {
    background: #ffebee;
    color: #f44336;
}

.btn-reject:hover {
    background: #ffcdd2;
}

.btn-edit {
    background: #fff3e0;
    color: #ff9800;
}

.btn-edit:hover {
    background: #ffe0b2;
}

.btn-delete {
    background: #fbe9e7;
    color: #d84315;
}

.btn-delete:hover {
    background: #ffccbc;
}

.btn-promote-junior {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #2e7d32 !important;
}

.btn-promote-junior:hover {
    background: #c8e6c9;
}

.btn-promote-moderator {
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #1976d32 !important;
}

.btn-promote-moderator:hover {
    background: #bbdefb;
}

.btn-demote {
    background: #ffebee;
    color: #f44336;
    border: 1px solid #f44336 !important;
}

.btn-demote:hover {
    background: #ffcdd2;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    color: white;
    display: inline-block;
}

.loading-cell {
    text-align: center;
    padding: 3rem !important;
    color: var(--text-secondary);
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 4rem;
    color: #e0e0e0;
    margin-bottom: 1rem;
}

/* Стили для затемненных полей в форме админа */
.admin-form-input {
    background-color: #f5f5f5 !important;
    border: 1px solid #ddd !important;
    color: #333 !important;
}

body.dark-mode .admin-form-input {
    background-color: #333 !important;
    border: 1px solid #444 !important;
    color: white !important;
}

.admin-form-input:focus {
    background-color: white !important;
    border-color: var(--primary-color) !important;
}

body.dark-mode .admin-form-input:focus {
    background-color: #444 !important;
    border-color: var(--primary-light) !important;
}

.hint {
    display: block;
    margin-top: 0.25rem;
    color: #666;
    font-size: 0.85rem;
}

.reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.report-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.report-card h3 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary-dark);
}

/* Стили для справочников */
.dictionaries-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.dictionaries-controls .btn {
    min-width: 150px;
}

.dictionary-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 1.5rem;
    min-height: 300px;
}

.dictionary-table {
    width: 100%;
    border-collapse: collapse;
}

.dictionary-table th {
    background: #f5f5f5;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid #e0e0e0;
}

.dictionary-table td {
    padding: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.dictionary-table tr:hover {
    background: #f9f9f9;
}

.color-preview {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    display: inline-block;
    margin-right: 0.5rem;
    vertical-align: middle;
}

/* Темная тема */
body.dark-mode .stat-card,
body.dark-mode .table-container,
body.dark-mode .table-controls,
body.dark-mode .report-card,
body.dark-mode .dictionary-content {
    background: #2d2d2d;
    color: var(--text-primary);
}

body.dark-mode .admin-table th {
    background: #333;
    color: var(--text-primary);
    border-bottom-color: #444;
}

body.dark-mode .admin-table td {
    border-bottom-color: #444;
}

body.dark-mode .admin-table tr:hover {
    background: #333;
}

body.dark-mode .dictionary-table th {
    background: #333;
    color: var(--text-primary);
    border-bottom-color: #444;
}

body.dark-mode .dictionary-table td {
    border-bottom-color: #444;
}

body.dark-mode .dictionary-table tr:hover {
    background: #333;
}

body.dark-mode .stat-value {
    color: var(--primary-light);
}

body.dark-mode .stat-label {
    color: #b0b0b0;
}

body.dark-mode .tab-btn:hover {
    background: #333;
}

body.dark-mode .tab-btn.active {
    color: var(--primary-light);
}

body.dark-mode .tab-btn.active:after {
    background: var(--primary-light);
}

body.dark-mode .admin-tabs {
    border-bottom-color: #444;
}

body.dark-mode .form-notice {
    background: #1b5e20;
    border-color: #2e7d32;
    color: white;
}

body.dark-mode .hint {
    color: #b0b0b0;
}

body.dark-mode .role-badge-super_admin {
    background: linear-gradient(135deg, #ffd700, #ffa500);
    color: #333;
}

body.dark-mode .role-badge-junior_admin {
    background: linear-gradient(135deg, #388e3c, #1b5e20);
    color: white;
}

body.dark-mode .role-badge-moderator {
    background: linear-gradient(135deg, #1976d2, #0d47a1);
    color: white;
}

body.dark-mode .role-badge-user {
    background: #333;
    color: #b0b0b0;
}

@media (max-width: 768px) {
    .admin-container {
        padding: 1rem;
    }

    .admin-table {
        display: block;
        overflow-x: auto;
        table-layout: auto;
    }

    .table-controls {
        flex-direction: column;
    }

    .reports-grid {
        grid-template-columns: 1fr;
    }

    .admin-tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
    }

    .actions-column {
        width: 150px;
        min-width: 150px;
    }

    .actions {
        flex-direction: column;
        gap: 0.25rem;
    }

    .actions button {
        width: 100%;
        justify-content: center;
    }

    .current-role-badge {
        position: static;
        margin-bottom: 1rem;
        text-align: center;
    }

    .admin-header h1 {
        text-align: center;
        justify-content: center;
    }

    .dictionaries-controls {
        flex-direction: column;
    }

    .dictionaries-controls .btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .admin-stats {
        grid-template-columns: 1fr;
    }

    .actions-column {
        width: 120px;
        min-width: 120px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация
    loadUsers();
    loadStatistics();

    // Открытие модального окна добавления зоны
    document.getElementById('open-add-zone-modal').addEventListener('click', function() {
        document.getElementById('add-zone-admin-modal').classList.add('active');
    });

    // Закрытие модальных окон
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').classList.remove('active');
        });
    });

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });

    // Переключение табов
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.dataset.tab;

            // Убираем активный класс у всех табов
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Добавляем активный класс текущему табу
            this.classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');

            // Загружаем данные для таба
            if (tabId === 'users') {
                loadUsers();
            } else if (tabId === 'reports') {
                loadStatistics();
            } else if (tabId === 'dictionaries') {
                loadDictionary('cities');
            }
        });
    });

    // Поиск зон
    const zoneSearch = document.getElementById('zone-search');
    if (zoneSearch) {
        zoneSearch.addEventListener('input', function() {
            filterZones(this.value);
        });
    }

    // Фильтры
    const cityFilter = document.getElementById('city-filter');
    const statusFilter = document.getElementById('status-filter');

    if (cityFilter) {
        cityFilter.addEventListener('change', filterZones);
    }

    if (statusFilter) {
        statusFilter.addEventListener('change', filterZones);
    }

    // Валидация координат в форме добавления зоны
    const adminZoneLat = document.getElementById('admin-zone-lat');
    const adminZoneLng = document.getElementById('admin-zone-lng');

    if (adminZoneLat) {
        adminZoneLat.addEventListener('input', function() {
            this.value = this.value.replace(/[^\d.-]/g, '');
        });
    }

    if (adminZoneLng) {
        adminZoneLng.addEventListener('input', function() {
            this.value = this.value.replace(/[^\d.-]/g, '');
        });
    }

    // Форма добавления зоны админом
    document.getElementById('add-zone-admin-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const area = document.getElementById('admin-zone-area').value;
        const areaUnit = document.getElementById('admin-zone-area-unit').value;
        let fullArea = '';

        if (area && area.trim()) {
            try {
                const areaValue = parseFloat(area);
                fullArea = `${areaValue} ${areaUnit}`;
            } catch (e) {
                fullArea = `${area} ${areaUnit}`;
            }
        }

        const formData = {
            name: document.getElementById('admin-zone-name').value,
            city: document.getElementById('admin-zone-city').value,
            type: document.getElementById('admin-zone-type').value,
            status: document.getElementById('admin-zone-status').value,
            lat: document.getElementById('admin-zone-lat').value,
            lng: document.getElementById('admin-zone-lng').value,
            area: fullArea,
            description: document.getElementById('admin-zone-description').value
        };

        // Валидация
        const lat = parseFloat(formData.lat);
        const lng = parseFloat(formData.lng);

        if (isNaN(lat) || lat < -90 || lat > 90) {
            alert('Пожалуйста, укажите корректную широту (-90 до 90)');
            return;
        }

        if (isNaN(lng) || lng < -180 || lng > 180) {
            alert('Пожалуйста, укажите корректную долготу (-180 до 180)');
            return;
        }

        if (!formData.name || !formData.city || !formData.type) {
            alert('Пожалуйста, заполните все обязательные поля');
            return;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Добавление...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('/api/admin/add-zone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                alert(`Зона успешно добавлена! ID: ${data.zone_id}`);
                document.getElementById('add-zone-admin-modal').classList.remove('active');
                this.reset();

                // Обновляем страницу, чтобы показать новую зону
                setTimeout(() => location.reload(), 1000);
            } else {
                alert(data.error || 'Ошибка добавления зоны');
            }
        } catch (error) {
            console.error('Ошибка добавления зоны:', error);
            alert('Ошибка соединения с сервером');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    // Форма назначения младшего администратора
    document.getElementById('promote-junior-admin-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const userId = document.getElementById('promote-junior-user-id').value;
        const adminPassword = document.getElementById('super-admin-password').value;

        if (!adminPassword) {
            alert('Пожалуйста, введите пароль супер-администратора');
            return;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Назначение...';
        submitBtn.disabled = true;

        try {
            const response = await fetch(`/api/admin/promote-junior-admin/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ admin_password: adminPassword })
            });

            const data = await response.json();

            if (data.success) {
                alert('Пользователь успешно назначен младшим администратором!');
                document.getElementById('promote-junior-admin-modal').classList.remove('active');
                loadUsers(); // Обновляем список пользователей
            } else {
                alert(data.error || 'Ошибка назначения младшего администратора');
            }
        } catch (error) {
            console.error('Ошибка назначения младшего администратора:', error);
            alert('Ошибка соединения с сервером');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            this.reset();
        }
    });

    // Форма назначения модератора
    document.getElementById('promote-moderator-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const userId = document.getElementById('promote-user-id').value;
        let adminPassword = '';

        // Для супер-администратора проверяем пароль
        if (window.user && window.user.role === 'super_admin') {
            adminPassword = document.getElementById('admin-password').value;
            if (!adminPassword) {
                alert('Пожалуйста, введите пароль администратора');
                return;
            }
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Назначение...';
        submitBtn.disabled = true;

        try {
            const response = await fetch(`/api/admin/promote-moderator/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ admin_password: adminPassword })
            });

            const data = await response.json();

            if (data.success) {
                alert('Пользователь успешно назначен модератором!');
                document.getElementById('promote-moderator-modal').classList.remove('active');
                loadUsers(); // Обновляем список пользователей
            } else {
                alert(data.error || 'Ошибка назначения модератора');
            }
        } catch (error) {
            console.error('Ошибка назначения модератора:', error);
            alert('Ошибка соединения с сервером');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            this.reset();
        }
    });

    // Форма понижения пользователя
    document.getElementById('demote-user-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const userId = document.getElementById('demote-user-id').value;
        const action = document.getElementById('confirm-demote').value;
        const userRole = document.getElementById('demote-user-role').value;
        let adminPassword = '';

        if (!action) {
            alert('Пожалуйста, выберите действие');
            return;
        }

        // Для удаления пользователя требуется пароль супер-администратора
        if (action === 'delete') {
            adminPassword = document.getElementById('delete-admin-password').value;
            if (!adminPassword) {
                alert('Пожалуйста, введите пароль супер-администратора для удаления пользователя');
                return;
            }
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обработка...';
        submitBtn.disabled = true;

        try {
            let response;
            if (action === 'delete') {
                response = await fetch(`/api/admin/delete-user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ admin_password: adminPassword })
                });
            } else {
                response = await fetch(`/api/admin/demote-user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
            }

            const data = await response.json();

            if (data.success) {
                const message = action === 'delete' ? 'Пользователь удален!' : 'Пользователь понижен до обычного пользователя!';
                alert(message);
                document.getElementById('demote-user-modal').classList.remove('active');
                loadUsers(); // Обновляем список пользователей
            } else {
                alert(data.error || 'Ошибка выполнения операции');
            }
        } catch (error) {
            console.error('Ошибка выполнения операции:', error);
            alert('Ошибка соединения с сервером');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            this.reset();
        }
    });

    // Показать/скрыть поле пароля при выборе действия удаления
    const confirmDemote = document.getElementById('confirm-demote');
    if (confirmDemote) {
        confirmDemote.addEventListener('change', function() {
            const passwordGroup = document.getElementById('admin-password-group');
            if (this.value === 'delete' && passwordGroup) {
                passwordGroup.style.display = 'block';
                document.getElementById('delete-admin-password').required = true;
            } else if (passwordGroup) {
                passwordGroup.style.display = 'none';
                document.getElementById('delete-admin-password').required = false;
            }
        });
    }

    // Управление справочниками
    document.querySelectorAll('[data-dict]').forEach(btn => {
        btn.addEventListener('click', function() {
            const dictType = this.dataset.dict;

            // Убираем активный класс у всех кнопок
            document.querySelectorAll('[data-dict]').forEach(b => {
                b.classList.remove('active-dict');
            });

            // Добавляем активный класс текущей кнопке
            this.classList.add('active-dict');

            // Загружаем данные справочника
            loadDictionary(dictType);
        });
    });
});

// Функция для выбора местоположения на карте
function pickLocationOnMap() {
    // Сохраняем текущее состояние формы
    sessionStorage.setItem('adminAddingZone', 'true');

    // Открываем главную страницу с картой в новой вкладке
    const city = document.getElementById('admin-zone-city').value || 'Барнаул';
    const url = `/?city=${encodeURIComponent(city)}&pick_location=true`;
    window.open(url, '_blank');

    alert('Выберите местоположение на карте в новой вкладке. Координаты автоматически подставятся в форму.');
}

// Загрузка данных с выбранным местоположением
if (sessionStorage.getItem('pickedLocation')) {
    try {
        const location = JSON.parse(sessionStorage.getItem('pickedLocation'));
        if (document.getElementById('admin-zone-lat')) {
            document.getElementById('admin-zone-lat').value = location.lat;
            document.getElementById('admin-zone-lng').value = location.lng;
        }
        sessionStorage.removeItem('pickedLocation');
        sessionStorage.removeItem('adminAddingZone');

        // Показываем уведомление
        if (document.getElementById('add-zone-admin-modal').classList.contains('active')) {
            alert('Координаты успешно загружены из карты!');
        }
    } catch (e) {
        console.error('Ошибка загрузки координат:', e);
    }
}

// Загрузка пользователей
async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users');
        if (!response.ok) {
            if (response.status === 401) {
                alert('Требуется авторизация для просмотра пользователей');
                return;
            }
            throw new Error('Ошибка загрузки пользователей');
        }

        const users = await response.json();
        const tbody = document.getElementById('users-tbody');
        const currentUserRole = window.user ? window.user.role : 'user';

        if (tbody) {
            tbody.innerHTML = users.map(user => {
                // Определяем бейдж роли
                let roleBadge = '';
                let roleClass = '';

                switch(user.role) {
                    case 'super_admin':
                        roleBadge = '<span class="role-badge-cell role-badge-super_admin"><i class="fas fa-crown"></i> Главный администратор</span>';
                        roleClass = 'super_admin';
                        break;
                    case 'junior_admin':
                        roleBadge = '<span class="role-badge-cell role-badge-junior_admin"><i class="fas fa-user-shield"></i> Младший администратор</span>';
                        roleClass = 'junior_admin';
                        break;
                    case 'moderator':
                        roleBadge = '<span class="role-badge-cell role-badge-moderator"><i class="fas fa-user-check"></i> Модератор</span>';
                        roleClass = 'moderator';
                        break;
                    default:
                        roleBadge = '<span class="role-badge-cell role-badge-user"><i class="fas fa-user"></i> Пользователь</span>';
                        roleClass = 'user';
                }

                // Определяем доступные действия в зависимости от роли текущего пользователя
                let actions = '';
                const isCurrentUser = window.user && window.user.id === user.id;

                if (!isCurrentUser) {
                    if (currentUserRole === 'super_admin') {
                        // Супер-администратор может назначать младших админов и модераторов, понижать всех кроме других супер-админов
                        if (user.role === 'user') {
                            actions = `
                                <button class="btn-promote-junior" onclick="promoteToJuniorAdmin(${user.id}, '${user.name}')" title="Назначить младшим администратором">
                                    <i class="fas fa-user-shield"></i>
                                </button>
                                <button class="btn-promote-moderator" onclick="promoteToModerator(${user.id}, '${user.name}')" title="Назначить модератором">
                                    <i class="fas fa-user-check"></i>
                                </button>
                                <button class="btn-demote" onclick="demoteUser(${user.id}, '${user.name}', '${user.role}')" title="Понизить/удалить" disabled>
                                    <i class="fas fa-user-minus"></i>
                                </button>
                            `;
                        } else if (user.role === 'moderator') {
                            actions = `
                                <button class="btn-promote-junior" onclick="promoteToJuniorAdmin(${user.id}, '${user.name}')" title="Назначить младшим администратором">
                                    <i class="fas fa-user-shield"></i>
                                </button>
                                <button class="btn-demote" onclick="demoteUser(${user.id}, '${user.name}', '${user.role}')" title="Понизить/удалить">
                                    <i class="fas fa-user-minus"></i>
                                </button>
                            `;
                        } else if (user.role === 'junior_admin') {
                            actions = `
                                <button class="btn-demote" onclick="demoteUser(${user.id}, '${user.name}', '${user.role}')" title="Понизить/удалить">
                                    <i class="fas fa-user-minus"></i>
                                </button>
                            `;
                        }
                    } else if (currentUserRole === 'junior_admin') {
                        // Младший администратор может назначать и понижать только модераторов
                        if (user.role === 'user') {
                            actions = `
                                <button class="btn-promote-moderator" onclick="promoteToModerator(${user.id}, '${user.name}')" title="Назначить модератором">
                                    <i class="fas fa-user-check"></i>
                                </button>
                                <button class="btn-demote" onclick="demoteUser(${user.id}, '${user.name}', '${user.role}')" title="Понизить" disabled>
                                    <i class="fas fa-user-minus"></i>
                                </button>
                            `;
                        } else if (user.role === 'moderator') {
                            actions = `
                                <button class="btn-demote" onclick="demoteUser(${user.id}, '${user.name}', '${user.role}')" title="Понизить">
                                    <i class="fas fa-user-minus"></i>
                                </button>
                            `;
                        }
                    }
                }

                return `
                    <tr id="user-row-${user.id}">
                        <td>${user.id}</td>
                        <td>
                            <strong>${user.name}</strong>
                            ${isCurrentUser ? '<span style="color: #666; font-size: 0.8rem; margin-left: 0.5rem;">(Вы)</span>' : ''}
                        </td>
                        <td>${user.email}</td>
                        <td>${roleBadge}</td>
                        <td>${user.city || 'Не указан'}</td>
                        <td>${user.created_at ? user.created_at.slice(0, 10) : ''}</td>
                        <td class="actions">
                            ${actions}
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Ошибка загрузки пользователей:', error);
        const tbody = document.getElementById('users-tbody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #f44336; padding: 2rem;">Ошибка загрузки данных пользователей</td></tr>';
        }
    }
}

// Назначение пользователя младшим администратором
function promoteToJuniorAdmin(userId, userName) {
    document.getElementById('promote-junior-user-id').value = userId;
    document.getElementById('promote-junior-user-name').value = userName;
    document.getElementById('promote-junior-admin-modal').classList.add('active');
}

// Назначение пользователя модератором
function promoteToModerator(userId, userName) {
    document.getElementById('promote-user-id').value = userId;
    document.getElementById('promote-user-name').value = userName;

    // Для супер-администратора показываем поле пароля
    if (window.user && window.user.role === 'super_admin') {
        document.getElementById('admin-password').required = true;
        document.getElementById('admin-password').style.display = 'block';
        document.querySelector('label[for="admin-password"]').style.display = 'block';
    } else {
        document.getElementById('admin-password').required = false;
        document.getElementById('admin-password').style.display = 'none';
        document.querySelector('label[for="admin-password"]').style.display = 'none';
    }

    document.getElementById('promote-moderator-modal').classList.add('active');
}

// Понижение пользователя
function demoteUser(userId, userName, userRole) {
    document.getElementById('demote-user-id').value = userId;
    document.getElementById('demote-user-name').value = userName;
    document.getElementById('demote-user-role').value = userRole;

    // Скрываем поле пароля по умолчанию
    const passwordGroup = document.getElementById('admin-password-group');
    if (passwordGroup) {
        passwordGroup.style.display = 'none';
        document.getElementById('delete-admin-password').required = false;
    }

    // Сбрасываем выбранное действие
    document.getElementById('confirm-demote').value = '';

    document.getElementById('demote-user-modal').classList.add('active');
}

async function loadStatistics() {
    try {
        const response = await fetch('/api/admin/statistics');
        const stats = await response.json();

        // Системная статистика
        const systemStats = document.getElementById('system-stats');
        if (systemStats) {
            systemStats.innerHTML = `
                <div class="stat-item"><strong>Всего зон:</strong> ${stats.total_zones}</div>
                <div class="stat-item"><strong>Всего пользователей:</strong> ${stats.total_users}</div>
                <div class="stat-item"><strong>Всего отчётов:</strong> ${stats.total_reports}</div>
                <div class="stat-item"><strong>Активных проблем:</strong> ${stats.active_problems}</div>
                <div class="stat-item"><strong>Выполненных работ:</strong> ${stats.completed_maintenance}</div>
            `;
        }

        // Активные проблемы
        const activeProblems = document.getElementById('active-problems');
        if (activeProblems) {
            if (stats.problems_by_type && stats.problems_by_type.length > 0) {
                activeProblems.innerHTML = stats.problems_by_type.map(p => `
                    <div class="problem-item">
                        <strong>${p.problem_type}:</strong> ${p.count} проблем
                    </div>
                `).join('');
            } else {
                activeProblems.innerHTML = '<p>Нет активных проблем</p>';
            }
        }

        // Статистика по городам
        const cityStats = document.getElementById('city-stats');
        if (cityStats && stats.zones_by_city) {
            cityStats.innerHTML = Object.entries(stats.zones_by_city)
                .map(([city, count]) => `
                    <div class="city-stat">
                        <strong>${city}:</strong> ${count} зон
                    </div>
                `).join('');
        }
    } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
    }
}

function filterZones() {
    const searchTerm = document.getElementById('zone-search')?.value.toLowerCase() || '';
    const city = document.getElementById('city-filter')?.value || '';
    const status = document.getElementById('status-filter')?.value || '';

    const rows = document.querySelectorAll('#zones-tab tbody tr');

    rows.forEach(row => {
        const name = row.cells[1].textContent.toLowerCase();
        const rowCity = row.cells[2].textContent;
        const rowStatus = row.cells[4].textContent.trim();

        const matchesSearch = name.includes(searchTerm);
        const matchesCity = !city || rowCity === city;
        const matchesStatus = !status || rowStatus === status;

        row.style.display = matchesSearch && matchesCity && matchesStatus ? '' : 'none';
    });
}

async function viewRequestDetails(requestId) {
    try {
        const response = await fetch(`/api/admin/request/${requestId}`);
        const request = await response.json();

        const modalContent = `
            <div class="request-details">
                <h3>${request.name}</h3>
                <div class="details-grid">
                    <div><strong>Город:</strong> ${request.city}</div>
                    <div><strong>Тип зоны:</strong> ${request.type}</div>
                    <div><strong>Координаты:</strong> ${request.lat}, ${request.lng}</div>
                    <div><strong>Площадь:</strong> ${request.area || 'Не указана'}</div>
                    <div><strong>Дата подачи:</strong> ${request.created_at}</div>
                    <div><strong>Пользователь:</strong> ${request.user_name} (${request.user_email})</div>
                </div>

                <div class="description-section">
                    <h4>Описание:</h4>
                    <p>${request.description || 'Описание отсутствует'}</p>
                </div>

                <div class="actions">
                    <button class="btn btn-success" onclick="approveRequest(${requestId})">
                        <i class="fas fa-check"></i> Принять
                    </button>
                    <button class="btn btn-danger" onclick="rejectRequest(${requestId})">
                        <i class="fas fa-times"></i> Отклонить
                    </button>
                </div>
            </div>
        `;

        document.getElementById('request-details').innerHTML = modalContent;
        document.getElementById('request-modal').classList.add('active');
    } catch (error) {
        console.error('Ошибка загрузки деталей заявки:', error);
        alert('Ошибка загрузки данных');
    }
}

async function approveRequest(requestId) {
    if (!confirm('Вы уверены, что хотите принять эту заявку?')) return;

    try {
        const response = await fetch(`/api/admin/approve-zone/${requestId}`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            alert('Заявка принята!');
            location.reload();
        } else {
            alert(data.error || 'Ошибка принятия заявки');
        }
    } catch (error) {
        console.error('Ошибка принятия заявки:', error);
        alert('Ошибка соединения');
    }
}

async function rejectRequest(requestId) {
    const reason = prompt('Укажите причину отклонения заявки:');
    if (reason === null) return;

    try {
        const response = await fetch(`/api/admin/reject-zone/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (data.success) {
            alert('Заявка отклонена!');
            location.reload();
        } else {
            alert(data.error || 'Ошибка отклонения заявки');
        }
    } catch (error) {
        console.error('Ошибка отклонения заявки:', error);
        alert('Ошибка соединения');
    }
}

// Функция для показа деталей зоны в модальном окне
async function showZoneDetailsModal(zoneId) {
    try {
        const response = await fetch(`/api/zone/${zoneId}`);
        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        const zone = data.zone;
        const problems = data.problems;
        const maintenance = data.maintenance;

        const modalContent = `
            <div class="zone-details">
                <h2>${zone.name}</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <strong>Город:</strong> ${zone.city}
                    </div>
                    <div class="detail-item">
                        <strong>Тип:</strong> ${zone.type}
                    </div>
                    <div class="detail-item">
                        <strong>Статус:</strong> ${zone.status}
                    </div>
                    <div class="detail-item">
                        <strong>Площадь:</strong> ${zone.area || 'Не указана'}
                    </div>
                    <div class="detail-item">
                        <strong>Создано:</strong> ${new Date(zone.created_at).toLocaleDateString('ru-RU')}
                    </div>
                </div>

                <div class="section">
                    <h3>Описание</h3>
                    <p>${zone.description || 'Описание отсутствует'}</p>
                </div>

                ${problems.length > 0 ? `
                <div class="section">
                    <h3>Последние проблемы (${problems.length})</h3>
                    <div class="problems-list">
                        ${problems.map(p => `
                            <div class="problem-item">
                                <div class="problem-header">
                                    <strong>${p.problem_type}</strong>
                                    <span class="problem-date">${new Date(p.created_at).toLocaleDateString('ru-RU')}</span>
                                </div>
                                <p>${p.description}</p>
                                <div class="problem-footer">
                                    <span>От: ${p.user_name}</span>
                                    <span class="problem-status">${p.status}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${maintenance.length > 0 ? `
                <div class="section">
                    <h3>История обслуживания</h3>
                    <div class="maintenance-list">
                        ${maintenance.map(m => `
                            <div class="maintenance-item">
                                <div class="maintenance-header">
                                    <strong>${m.action_type}</strong>
                                    <span class="maintenance-date">${new Date(m.performed_at).toLocaleDateString('ru-RU')}</span>
                                </div>
                                <p>${m.description}</p>
                                ${m.cost ? `<div><strong>Стоимость:</strong> ${m.cost} руб.</div>` : ''}
                                ${m.duration_minutes ? `<div><strong>Длительность:</strong> ${m.duration_minutes} мин.</div>` : ''}
                                <div class="maintenance-footer">
                                    <span>Исполнитель: ${m.user_name}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;

        // Создаем и показываем модальное окно
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Детали зоны</h3>
                    <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${modalContent}
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Закрытие по клику вне окна
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.remove();
            }
        });

        // Добавляем обработчик закрытия для кнопки
        modal.querySelector('.close-modal').addEventListener('click', function() {
            modal.remove();
        });

    } catch (error) {
        console.error('Ошибка загрузки деталей зоны:', error);
        alert('Ошибка загрузки информации о зоне');
    }
}

async function editZone(zoneId) {
    try {
        const response = await fetch(`/api/admin/zone/${zoneId}`);
        const zone = await response.json();

        if (zone.error) {
            alert(zone.error);
            return;
        }

        // Получаем текущие справочники для выпадающих списков
        const citiesResponse = await fetch('/api/dictionaries/cities');
        const citiesData = await citiesResponse.json();

        const zoneTypesResponse = await fetch('/api/dictionaries/zone_types');
        const zoneTypesData = await zoneTypesResponse.json();

        const statusesResponse = await fetch('/api/dictionaries/statuses');
        const statusesData = await statusesResponse.json();

        // Парсим площадь для отображения
        let areaValue = '';
        let areaUnit = 'га';

        if (zone.area) {
            if (zone.area.includes('м²') || zone.area.includes('м2')) {
                areaUnit = 'м²';
                areaValue = zone.area.replace(/[^0-9.,]/g, '').replace(',', '.');
            } else {
                areaUnit = 'га';
                areaValue = zone.area.replace(/[^0-9.,]/g, '').replace(',', '.');
            }
        }


        const formHtml = `
            <form id="edit-zone-form-${zoneId}">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-name-${zoneId}">Название зоны *</label>
                        <input type="text" id="edit-name-${zoneId}" value="${zone.name}" required class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-city-${zoneId}">Город *</label>
                        <select id="edit-city-${zoneId}" required class="admin-form-input">
                            <option value="">Выберите город</option>
                            ${Object.keys(window.citiesData || {}).map(city => `
                                <option value="${city}" ${zone.city === city ? 'selected' : ''}>${city}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-type-${zoneId}">Тип зоны *</label>
                        <select id="edit-type-${zoneId}" required class="admin-form-input">
                            ${window.zoneTypes?.map(type => `
                                <option value="${type}" ${zone.type === type ? 'selected' : ''}>${type}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-status-${zoneId}">Статус *</label>
                        <select id="edit-status-${zoneId}" required class="admin-form-input">
                            ${Object.keys(window.statuses || {}).map(status => `
                                <option value="${status}" ${zone.status === status ? 'selected' : ''}>${status}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-lat-${zoneId}">Широта *</label>
                        <input type="text" id="edit-lat-${zoneId}" value="${zone.lat}" required
                               pattern="^-?\d+(\.\d+)?$"
                               title="Только цифры и точка" class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-lng-${zoneId}">Долгота *</label>
                        <input type="text" id="edit-lng-${zoneId}" value="${zone.lng}" required
                               pattern="^-?\d+(\.\d+)?$"
                               title="Только цифры и точка" class="admin-form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-description-${zoneId}">Описание *</label>
                    <textarea id="edit-description-${zoneId}" rows="4" required class="admin-form-input">${zone.description || ''}</textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Сохранить изменения
                    </button>
                </div>
            </form>
        `;

        document.getElementById('edit-zone-form-container').innerHTML = formHtml;
        document.getElementById('edit-zone-modal').classList.add('active');

        // Валидация ввода координат
        const latInput = document.getElementById(`edit-lat-${zoneId}`);
        const lngInput = document.getElementById(`edit-lng-${zoneId}`);

        if (latInput) {
            latInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^\d.-]/g, '');
            });
        }

        if (lngInput) {
            lngInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^\d.-]/g, '');
            });
        }

        // Обработка формы
        document.getElementById(`edit-zone-form-${zoneId}`).addEventListener('submit', async (e) => {
            e.preventDefault();
            await updateZone(zoneId);
        });
    } catch (error) {
        console.error('Ошибка загрузки данных зоны:', error);
        alert('Ошибка загрузки данных');
    }
}

// Обновление зоны
async function updateZone(zoneId) {
    const area = document.getElementById(`edit-area-${zoneId}`).value;
    const areaUnit = document.getElementById(`edit-area-unit-${zoneId}`).value;
    let fullArea = '';

    if (area && area.trim()) {
        try {
            const areaValue = parseFloat(area);
            fullArea = `${areaValue} ${areaUnit}`;
        } catch (e) {
            fullArea = `${area} ${areaUnit}`;
        }
    }

    const formData = {
        name: document.getElementById(`edit-name-${zoneId}`).value,
        city: document.getElementById(`edit-city-${zoneId}`).value,
        type: document.getElementById(`edit-type-${zoneId}`).value,
        status: document.getElementById(`edit-status-${zoneId}`).value,
        lat: document.getElementById(`edit-lat-${zoneId}`).value,
        lng: document.getElementById(`edit-lng-${zoneId}`).value,
        area: fullArea,
        description: document.getElementById(`edit-description-${zoneId}`).value
    };

    // Валидация
    const lat = parseFloat(formData.lat);
    const lng = parseFloat(formData.lng);

    if (isNaN(lat) || lat < -90 || lat > 90) {
        alert('Пожалуйста, укажите корректную широту (-90 до 90)');
        return;
    }

    if (isNaN(lng) || lng < -180 || lng > 180) {
        alert('Пожалуйста, укажите корректную долготу (-180 до 180)');
        return;
    }

    try {
        const response = await fetch(`/api/admin/zone/${zoneId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            alert('Зона успешно обновлена!');
            document.getElementById('edit-zone-modal').classList.remove('active');
            location.reload(); // Перезагружаем страницу
        } else {
            alert(data.error || 'Ошибка обновления зоны');
        }
    } catch (error) {
        console.error('Ошибка обновления зоны:', error);
        alert('Ошибка соединения с сервером');
    }
}

async function deleteZone(zoneId) {
    if (!confirm('Вы уверены, что хотите удалить эту зону? Все связанные отчеты и история обслуживания также будут удалены.')) return;

    try {
        const response = await fetch(`/api/admin/zone/${zoneId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            alert('Зона удалена!');
            // Удаляем строку из таблицы без перезагрузки страницы
            const row = document.querySelector(`tr:has(td:contains("${zoneId}"))`);
            if (row) {
                row.remove();
            }
            // Обновляем статистику
            updateZoneStats();
        } else {
            alert(data.error || 'Ошибка удаления зоны');
        }
    } catch (error) {
        console.error('Ошибка удаления зоны:', error);
        alert('Ошибка соединения');
    }
}

// Функция для обновления статистики зон
function updateZoneStats() {
    const zoneCount = document.querySelectorAll('#zones-tab tbody tr').length;
    const statCard = document.querySelector('.stat-card:nth-child(2) .stat-value');
    if (statCard) {
        statCard.textContent = zoneCount;
    }
}

function generateSystemReport() {
    // Генерация системного отчета
    const report = {
        title: 'Системный отчет ЭКОПУЛЬС',
        date: new Date().toLocaleDateString('ru-RU'),
        data: {}
    };

    // Здесь можно добавить логику сбора данных для отчета

    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ecopulse_system_report_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Функция для загрузки справочника
async function loadDictionary(dictType) {
    try {
        const response = await fetch(`/api/dictionaries/${dictType}`);
        const data = await response.json();

        const container = document.getElementById('dictionary-content');

        if (!data.length) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-database"></i>
                    <h3>Справочник пуст</h3>
                    <p>Данные не найдены</p>
                </div>
            `;
            return;
        }

        // Определяем заголовки в зависимости от типа справочника
        let headers = [];
        let tableRows = '';

        switch(dictType) {
            case 'cities':
                headers = ['ID', 'Название', 'Широта', 'Долгота', 'Зум', 'Статус', 'Действия'];
                tableRows = data.map(item => `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.lat}</td>
                        <td>${item.lng}</td>
                        <td>${item.zoom}</td>
                        <td>${item.is_active ? '<span style="color: #4caf50;">Активен</span>' : '<span style="color: #f44336;">Неактивен</span>'}</td>
                        <td class="actions">
                            <button class="btn-edit" onclick="editDictionaryItem('${dictType}', ${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" onclick="deleteDictionaryItem('${dictType}', ${item.id}, '${item.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                break;

            case 'statuses':
                headers = ['ID', 'Название', 'Цвет', 'Иконка', 'Приоритет', 'Статус', 'Действия'];
                tableRows = data.map(item => `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>
                            <span class="color-preview" style="background-color: ${item.color}"></span>
                            ${item.color}
                        </td>
                        <td>${item.icon || '—'}</td>
                        <td>${item.priority}</td>
                        <td>${item.is_active ? '<span style="color: #4caf50;">Активен</span>' : '<span style="color: #f44336;">Неактивен</span>'}</td>
                        <td class="actions">
                            <button class="btn-edit" onclick="editDictionaryItem('${dictType}', ${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" onclick="deleteDictionaryItem('${dictType}', ${item.id}, '${item.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                break;

            default:
                headers = ['ID', 'Название', 'Описание', 'Статус', 'Действия'];
                tableRows = data.map(item => `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.description || '—'}</td>
                        <td>${item.is_active ? '<span style="color: #4caf50;">Активен</span>' : '<span style="color: #f44336;">Неактивен</span>'}</td>
                        <td class="actions">
                            <button class="btn-edit" onclick="editDictionaryItem('${dictType}', ${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" onclick="deleteDictionaryItem('${dictType}', ${item.id}, '${item.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
        }

        container.innerHTML = `
            <div class="dictionary-header">
                <h3>Справочник: ${getDictionaryTitle(dictType)} (${data.length} записей)</h3>
                <button class="btn btn-primary" onclick="addDictionaryItem('${dictType}')">
                    <i class="fas fa-plus"></i> Добавить
                </button>
            </div>
            <table class="dictionary-table">
                <thead>
                    <tr>
                        ${headers.map(header => `<th>${header}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;

    } catch (error) {
        console.error('Ошибка загрузки справочника:', error);
        document.getElementById('dictionary-content').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Ошибка загрузки</h3>
                <p>Не удалось загрузить данные справочника</p>
            </div>
        `;
    }
}

function getDictionaryTitle(dictType) {
    const titles = {
        'cities': 'Города',
        'zone_types': 'Типы зон',
        'statuses': 'Статусы зон',
        'problem_types': 'Типы проблем'
    };
    return titles[dictType] || dictType;
}

function addDictionaryItem(dictType) {
    let formHtml = '';
    const title = getDictionaryTitle(dictType);

    switch(dictType) {
        case 'cities':
            formHtml = `
                <form id="add-dictionary-form">
                    <div class="form-group">
                        <label for="dict-name">Название города *</label>
                        <input type="text" id="dict-name" required class="admin-form-input">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dict-lat">Широта *</label>
                            <input type="number" step="0.000001" id="dict-lat" required class="admin-form-input">
                        </div>
                        <div class="form-group">
                            <label for="dict-lng">Долгота *</label>
                            <input type="number" step="0.000001" id="dict-lng" required class="admin-form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="dict-zoom">Уровень зума</label>
                        <input type="number" id="dict-zoom" value="12" min="1" max="18" class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="dict-active">Статус</label>
                        <select id="dict-active" class="admin-form-input">
                            <option value="1">Активен</option>
                            <option value="0">Неактивен</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Добавить</button>
                    </div>
                </form>
            `;
            break;

        case 'statuses':
            formHtml = `
                <form id="add-dictionary-form">
                    <div class="form-group">
                        <label for="dict-name">Название статуса *</label>
                        <input type="text" id="dict-name" required class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="dict-color">Цвет *</label>
                        <input type="color" id="dict-color" value="#4caf50" required class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="dict-icon">Иконка (emoji)</label>
                        <input type="text" id="dict-icon" placeholder="🟢" class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="dict-priority">Приоритет (1-5)</label>
                        <input type="number" id="dict-priority" value="3" min="1" max="5" class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="dict-active">Статус</label>
                        <select id="dict-active" class="admin-form-input">
                            <option value="1">Активен</option>
                            <option value="0">Неактивен</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Добавить</button>
                    </div>
                </form>
            `;
            break;

        default:
            formHtml = `
                <form id="add-dictionary-form">
                    <div class="form-group">
                        <label for="dict-name">Название *</label>
                        <input type="text" id="dict-name" required class="admin-form-input">
                    </div>
                    <div class="form-group">
                        <label for="dict-description">Описание</label>
                        <textarea id="dict-description" rows="3" class="admin-form-input"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="dict-active">Статус</label>
                        <select id="dict-active" class="admin-form-input">
                            <option value="1">Активен</option>
                            <option value="0">Неактивен</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Добавить</button>
                    </div>
                </form>
            `;
    }

    document.getElementById('dictionary-modal-title').textContent = `Добавить в справочник: ${title}`;
    document.getElementById('dictionary-modal-content').innerHTML = formHtml;
    document.getElementById('dictionary-modal').classList.add('active');

    // Обработка формы
    document.getElementById('add-dictionary-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        await saveDictionaryItem(dictType, null);
    });
}

async function editDictionaryItem(dictType, itemId) {
    try {
        const response = await fetch(`/api/dictionaries/${dictType}`);
        const data = await response.json();
        const item = data.find(i => i.id === itemId);

        if (!item) {
            alert('Элемент не найден');
            return;
        }

        const title = getDictionaryTitle(dictType);
        let formHtml = '';

        switch(dictType) {
            case 'cities':
                formHtml = `
                    <form id="edit-dictionary-form">
                        <div class="form-group">
                            <label for="dict-name">Название города *</label>
                            <input type="text" id="dict-name" value="${item.name}" required class="admin-form-input">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dict-lat">Широта *</label>
                                <input type="number" step="0.000001" id="dict-lat" value="${item.lat}" required class="admin-form-input">
                            </div>
                            <div class="form-group">
                                <label for="dict-lng">Долгота *</label>
                                <input type="number" step="0.000001" id="dict-lng" value="${item.lng}" required class="admin-form-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dict-zoom">Уровень зума</label>
                            <input type="number" id="dict-zoom" value="${item.zoom}" min="1" max="18" class="admin-form-input">
                        </div>
                        <div class="form-group">
                            <label for="dict-active">Статус</label>
                            <select id="dict-active" class="admin-form-input">
                                <option value="1" ${item.is_active ? 'selected' : ''}>Активен</option>
                                <option value="0" ${!item.is_active ? 'selected' : ''}>Неактивен</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                        </div>
                    </form>
                `;
                break;

            case 'statuses':
                formHtml = `
                    <form id="edit-dictionary-form">
                        <div class="form-group">
                            <label for="dict-name">Название статуса *</label>
                            <input type="text" id="dict-name" value="${item.name}" required class="admin-form-input">
                        </div>
                        <div class="form-group">
                            <label for="dict-color">Цвет *</label>
                            <input type="color" id="dict-color" value="${item.color}" required class="admin-form-input">
                        </div>
                        <div class="form-group">
                            <label for="dict-icon">Иконка (emoji)</label>
                            <input type="text" id="dict-icon" value="${item.icon || ''}" placeholder="🟢" class="admin-form-input">
                        </div>
                        <div class="form-group">
                            <label for="dict-priority">Приоритет (1-5)</label>
                            <input type="number" id="dict-priority" value="${item.priority}" min="1" max="5" class="admin-form-input">
                        </div>
                        <div class="form-group">
                            <label for="dict-active">Статус</label>
                            <select id="dict-active" class="admin-form-input">
                                <option value="1" ${item.is_active ? 'selected' : ''}>Активен</option>
                                <option value="0" ${!item.is_active ? 'selected' : ''}>Неактивен</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                        </div>
                    </form>
                `;
                break;

            default:
                formHtml = `
                    <form id="edit-dictionary-form">
                        <div class="form-group">
                            <label for="dict-name">Название *</label>
                            <input type="text" id="dict-name" value="${item.name}" required class="admin-form-input">
                        </div>
                        <div class="form-group">
                            <label for="dict-description">Описание</label>
                            <textarea id="dict-description" rows="3" class="admin-form-input">${item.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="dict-active">Статус</label>
                            <select id="dict-active" class="admin-form-input">
                                <option value="1" ${item.is_active ? 'selected' : ''}>Активен</option>
                                <option value="0" ${!item.is_active ? 'selected' : ''}>Неактивен</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                        </div>
                    </form>
                `;
        }

        document.getElementById('dictionary-modal-title').textContent = `Редактирование: ${title}`;
        document.getElementById('dictionary-modal-content').innerHTML = formHtml;
        document.getElementById('dictionary-modal').classList.add('active');

        // Обработка формы
        document.getElementById('edit-dictionary-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveDictionaryItem(dictType, itemId);
        });

    } catch (error) {
        console.error('Ошибка загрузки элемента:', error);
        alert('Ошибка загрузки данных');
    }
}

async function saveDictionaryItem(dictType, itemId) {
    const form = document.getElementById(itemId ? 'edit-dictionary-form' : 'add-dictionary-form');
    const formData = new FormData(form);

    let data = {};

    if (dictType === 'cities') {
        data = {
            name: document.getElementById('dict-name').value,
            lat: parseFloat(document.getElementById('dict-lat').value),
            lng: parseFloat(document.getElementById('dict-lng').value),
            zoom: parseInt(document.getElementById('dict-zoom').value),
            is_active: parseInt(document.getElementById('dict-active').value)
        };
    } else if (dictType === 'statuses') {
        data = {
            name: document.getElementById('dict-name').value,
            color: document.getElementById('dict-color').value,
            icon: document.getElementById('dict-icon').value,
            priority: parseInt(document.getElementById('dict-priority').value),
            is_active: parseInt(document.getElementById('dict-active').value)
        };
    } else {
        data = {
            name: document.getElementById('dict-name').value,
            description: document.getElementById('dict-description').value,
            is_active: parseInt(document.getElementById('dict-active').value)
        };
    }

    try {
        const url = itemId ?
            `/api/admin/dictionaries/${dictType}/${itemId}` :
            `/api/admin/dictionaries/${dictType}`;

        const method = itemId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            document.getElementById('dictionary-modal').classList.remove('active');
            loadDictionary(dictType); // Обновляем список
        } else {
            alert(result.error || 'Ошибка сохранения');
        }
    } catch (error) {
        console.error('Ошибка сохранения:', error);
        alert('Ошибка соединения с сервером');
    }
}

async function deleteDictionaryItem(dictType, itemId, itemName) {
    if (!confirm(`Вы уверены, что хотите удалить элемент "${itemName}"?`)) return;

    try {
        const response = await fetch(`/api/admin/dictionaries/${dictType}/${itemId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            loadDictionary(dictType); // Обновляем список
        } else {
            alert(result.error || 'Ошибка удаления');
        }
    } catch (error) {
        console.error('Ошибка удаления:', error);
        alert('Ошибка соединения с сервером');
    }
}
</script>

{% endblock %}