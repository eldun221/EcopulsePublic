{% extends "base.html" %}

{% block title %}Аналитика - ЭКОПУЛЬС {{ city }}{% endblock %}

{% block content %}

<div class="analytics-container">
    <div class="analytics-header">
        <h1><i class="fas fa-chart-line"></i> Аналитика по городу {{ city }}</h1>
        <div class="analytics-controls">
            <div class="city-selector">
                <select id="analytics-city">
                    {% for city_name in cities.keys() %}
                    <option value="{{ city_name }}" {% if city_name == city %}selected{% endif %}>
                        {{ city_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="period-selector">
                <select id="analytics-period">
                    <option value="month" selected>За месяц</option>
                    <option value="quarter">За квартал</option>
                    <option value="year">За год</option>
                </select>
            </div>

            <button class="btn btn-primary" id="generate-report">
                <i class="fas fa-download"></i> Скачать отчет
            </button>
        </div>
    </div>

    <!-- Основные метрики -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon" style="background: #e8f5e9;">
                <i class="fas fa-tree" style="color: #4caf50;"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="total-zones">{{ stats.total }}</div>
                <div class="metric-label">Всего зелёных зон</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: #e3f2fd;">
                <i class="fas fa-seedling" style="color: #2196f3;"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="good-zones">{{ stats.good_percent }}%</div>
                <div class="metric-label">В хорошем состоянии</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: #fff3e0;">
                <i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="problem-zones">{{ stats.needs_care + stats.critical }}</div>
                <div class="metric-label">С проблемами</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: #fce4ec;">
                <i class="fas fa-tools" style="color: #e91e63;"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="maintenance-count">{{ stats.problems_count }}</div>
                <div class="metric-label">Активных проблем</div>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Распределение зон по статусам</h3>
            </div>
            <div class="chart-container">
                <canvas id="status-chart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Распределение по типам зон</h3>
            </div>
            <div class="chart-container">
                <canvas id="type-chart"></canvas>
            </div>
        </div>

<!--        <div class="chart-card">-->
<!--            <div class="chart-header">-->
<!--                <h3>Динамика добавления зон и проблем</h3>-->
<!--            </div>-->
<!--            <div class="chart-container">-->
<!--                <canvas id="dynamics-chart"></canvas>-->
<!--            </div>-->
<!--        </div>-->

        <div class="chart-card">
            <div class="chart-header">
                <h3>Распределение типов проблем</h3>
            </div>
            <div class="chart-container">
                <canvas id="problems-chart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Затраты на обслуживание по типам зон</h3>
            </div>
            <div class="chart-container">
                <canvas id="costs-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Прогнозы -->
    <div class="predictions-section">
        <h2><i class="fas fa-crystal-ball"></i> Прогнозы и рекомендации</h2>

        <div class="predictions-grid">
            <div class="prediction-card">
                <div class="prediction-header">
                    <i class="fas fa-leaf"></i>
                    <h3>Состояние зон через месяц</h3>
                </div>
                <div class="prediction-content" id="status-prediction">
                    <div class="loading">Загрузка прогноза...</div>
                </div>
            </div>

            <div class="prediction-card">
                <div class="prediction-header">
                    <i class="fas fa-money-bill-wave"></i>
                    <h3>Бюджет на обслуживание</h3>
                </div>
                <div class="prediction-content" id="budget-prediction">
                    <div class="loading">Расчет бюджета...</div>
                </div>
            </div>

            <div class="prediction-card">
                <div class="prediction-header">
                    <i class="fas fa-tasks"></i>
                    <h3>Рекомендуемые работы</h3>
                </div>
                <div class="prediction-content" id="recommendations">
                    <div class="loading">Формирование рекомендаций...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Детальная статистика -->
    <div class="detailed-stats">
        <h2><i class="fas fa-table"></i> Детальная статистика</h2>

        <div class="stats-tabs">
            <button class="stats-tab active" data-tab="zones">Зоны</button>
            <button class="stats-tab" data-tab="problems">Проблемы</button>
            <button class="stats-tab" data-tab="maintenance">Обслуживание</button>
        </div>

        <div class="stats-content active" id="zones-stats">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Тип зоны</th>
                        <th>Всего</th>
                        <th>Отличное</th>
                        <th>Хорошее</th>
                        <th>Удовлетворительное</th>
                        <th>Требует ухода</th>
                        <th>Критическое</th>
                    </tr>
                </thead>
                <tbody id="zones-stats-body">
                    <!-- Данные загружаются через JS -->
                </tbody>
            </table>
        </div>

        <div class="stats-content" id="problems-stats">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Тип проблемы</th>
                        <th>Количество</th>
                    </tr>
                </thead>
                <tbody id="problems-stats-body">
                    {% for stat in problem_stats %}
                    <tr>
                        <td>{{ stat.problem_type }}</td>
                        <td>{{ stat.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="stats-content" id="maintenance-stats">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Период</th>
                        <th>Месячный бюджет</th>
                        <th>Квартальный бюджет</th>
                        <th>Годовой бюджет</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Общие затраты</td>
                        <td>{{ "%.0f"|format(costs.total_monthly) }} руб.</td>
                        <td>{{ "%.0f"|format(costs.total_quarterly) }} руб.</td>
                        <td>{{ "%.0f"|format(costs.total_annual) }} руб.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/analytics.js') }}"></script>
{% endblock %}