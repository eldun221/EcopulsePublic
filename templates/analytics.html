{% extends "base.html" %}

{% block title %}Аналитика - ЭКОПУЛЬС {{ city }}{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <h1><i class="fas fa-chart-line"></i> Аналитика по городу {{ city }}</h1>
        <div class="analytics-controls">
            <div class="city-selector">
                <select id="analytics-city">
                    {% for city_name in cities.keys() %}
                    <option value="{{ city_name }}" {% if city_name == city %}selected{% endif %}>
                        {{ city_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="period-selector">
                <select id="analytics-period">
                    <option value="month" selected>За месяц</option>
                    <option value="quarter">За квартал</option>
                    <option value="year">За год</option>
                </select>
            </div>

            <button class="btn btn-primary" id="generate-report">
                <i class="fas fa-download"></i> Скачать отчет
            </button>
        </div>
    </div>

    <!-- Основные метрики -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon" style="background: #e8f5e9;">
                <i class="fas fa-tree" style="color: #4caf50;"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="total-zones">{{ stats.total }}</div>
                <div class="metric-label">Всего зелёных зон</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: #e3f2fd;">
                <i class="fas fa-seedling" style="color: #2196f3;"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="good-zones">{{ stats.good_percent }}%</div>
                <div class="metric-label">В хорошем состоянии</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: #fff3e0;">
                <i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="problem-zones">{{ stats.needs_care + stats.critical }}</div>
                <div class="metric-label">С проблемами</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: #fce4ec;">
                <i class="fas fa-tools" style="color: #e91e63;"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="maintenance-count">{{ stats.problems_count }}</div>
                <div class="metric-label">Активных проблем</div>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Распределение зон по статусам</h3>
            </div>
            <div class="chart-container">
                <canvas id="status-chart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3>Распределение по типам зон</h3>
            </div>
            <div class="chart-container">
                <canvas id="type-chart"></canvas>
            </div>
        </div>

<!--        <div class="chart-card">-->
<!--            <div class="chart-header">-->
<!--                <h3>Динамика добавления зон и проблем</h3>-->
<!--            </div>-->
<!--            <div class="chart-container">-->
<!--                <canvas id="dynamics-chart"></canvas>-->
<!--            </div>-->
<!--        </div>-->

        <div class="chart-card">
            <div class="chart-header">
                <h3>Распределение типов проблем</h3>
            </div>
            <div class="chart-container">
                <canvas id="problems-chart"></canvas>
            </div>
        </div>

        <div class="chart-card full-width">
            <div class="chart-header">
                <h3>Затраты на обслуживание по типам зон</h3>
            </div>
            <div class="chart-container">
                <canvas id="costs-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Прогнозы -->
    <div class="predictions-section">
        <h2><i class="fas fa-crystal-ball"></i> Прогнозы и рекомендации</h2>

        <div class="predictions-grid">
            <div class="prediction-card">
                <div class="prediction-header">
                    <i class="fas fa-leaf"></i>
                    <h3>Состояние зон через месяц</h3>
                </div>
                <div class="prediction-content" id="status-prediction">
                    <div class="loading">Загрузка прогноза...</div>
                </div>
            </div>

            <div class="prediction-card">
                <div class="prediction-header">
                    <i class="fas fa-money-bill-wave"></i>
                    <h3>Бюджет на обслуживание</h3>
                </div>
                <div class="prediction-content" id="budget-prediction">
                    <div class="loading">Расчет бюджета...</div>
                </div>
            </div>

            <div class="prediction-card">
                <div class="prediction-header">
                    <i class="fas fa-tasks"></i>
                    <h3>Рекомендуемые работы</h3>
                </div>
                <div class="prediction-content" id="recommendations">
                    <div class="loading">Формирование рекомендаций...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Детальная статистика -->
    <div class="detailed-stats">
        <h2><i class="fas fa-table"></i> Детальная статистика</h2>

        <div class="stats-tabs">
            <button class="stats-tab active" data-tab="zones">Зоны</button>
            <button class="stats-tab" data-tab="problems">Проблемы</button>
            <button class="stats-tab" data-tab="maintenance">Обслуживание</button>
        </div>

        <div class="stats-content active" id="zones-stats">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Тип зоны</th>
                        <th>Всего</th>
                        <th>Отличное</th>
                        <th>Хорошее</th>
                        <th>Удовлетворительное</th>
                        <th>Требует ухода</th>
                        <th>Критическое</th>
                    </tr>
                </thead>
                <tbody id="zones-stats-body">
                    <!-- Данные загружаются через JS -->
                </tbody>
            </table>
        </div>

        <div class="stats-content" id="problems-stats">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Тип проблемы</th>
                        <th>Количество</th>
                    </tr>
                </thead>
                <tbody id="problems-stats-body">
                    {% for stat in problem_stats %}
                    <tr>
                        <td>{{ stat.problem_type }}</td>
                        <td>{{ stat.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="stats-content" id="maintenance-stats">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Период</th>
                        <th>Месячный бюджет</th>
                        <th>Квартальный бюджет</th>
                        <th>Годовой бюджет</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Общие затраты</td>
                        <td>{{ "%.0f"|format(costs.total_monthly) }} руб.</td>
                        <td>{{ "%.0f"|format(costs.total_quarterly) }} руб.</td>
                        <td>{{ "%.0f"|format(costs.total_annual) }} руб.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Цвета для светлой и темной темы
const chartColors = {
    light: {
        excellent: '#4caf50',
        good: '#8bc34a',
        satisfactory: '#ffeb3b',
        needsCare: '#ff9800',
        critical: '#f44336',
        primary: '#2e7d32',
        secondary: '#81c784',
        accent: '#8bc34a',
        blue: '#2196f3',
        purple: '#9c27b0',
        gray: '#607d8b'
    },
    dark: {
        excellent: '#388e3c',
        good: '#689f38',
        satisfactory: '#fbc02d',
        needsCare: '#f57c00',
        critical: '#d32f2f',
        primary: '#4caf50',
        secondary: '#81c784',
        accent: '#8bc34a',
        blue: '#1976d2',
        purple: '#7b1fa2',
        gray: '#455a64'
    }
};

// Получение текущей цветовой схемы
function getChartColors() {
    const isDarkMode = document.body.classList.contains('dark-mode');
    return isDarkMode ? chartColors.dark : chartColors.light;
}

class AnalyticsDashboard {
    constructor() {
        this.charts = {};
        this.currentCity = document.getElementById('analytics-city')?.value || '{{ city }}';
        this.currentPeriod = 'month';
        this.initialize();
    }

    initialize() {
        this.setupEventListeners();
        this.loadAnalyticsData();
        this.loadPredictions();
        this.loadDetailedStats();
    }

    setupEventListeners() {
        // Город селектор
        const citySelect = document.getElementById('analytics-city');
        if (citySelect) {
            citySelect.addEventListener('change', () => {
                this.currentCity = citySelect.value;
                this.reloadAllData();
            });
        }

        // Период селектор
        const periodSelect = document.getElementById('analytics-period');
        if (periodSelect) {
            periodSelect.addEventListener('change', () => {
                this.currentPeriod = periodSelect.value;
                this.reloadAllData();
            });
        }

        // Кнопка генерации отчета
        const generateReportBtn = document.getElementById('generate-report');
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', () => {
                this.generateReport();
            });
        }

        // Переключение табов статистики
        document.querySelectorAll('.stats-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;

                document.querySelectorAll('.stats-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.stats-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(`${tabId}-stats`).classList.add('active');
            });
        });

        // Обработчик изменения темы
        const observer = new MutationObserver(() => {
            this.updateChartsForTheme();
        });
        observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
    }

    async reloadAllData() {
        await this.loadAnalyticsData();
        await this.loadPredictions();
        await this.loadDetailedStats();
    }

    async loadAnalyticsData() {
        try {
            const response = await fetch(`/api/analytics/data?city=${encodeURIComponent(this.currentCity)}&period=${this.currentPeriod}`);
            if (!response.ok) throw new Error('Ошибка загрузки данных');

            const data = await response.json();
            this.updateMetrics(data.metrics);
            this.renderCharts(data);
        } catch (error) {
            console.error('Ошибка загрузки аналитики:', error);
            this.showError('Ошибка загрузки данных. Пожалуйста, попробуйте позже.');
        }
    }

    updateMetrics(metrics) {
        document.getElementById('total-zones').textContent = metrics.total_zones || 0;

        const goodPercent = metrics.total_zones > 0
            ? Math.round((metrics.good_zones / metrics.total_zones) * 100)
            : 0;
        document.getElementById('good-zones').textContent = `${goodPercent}%`;

        document.getElementById('problem-zones').textContent = metrics.problem_zones || 0;
        document.getElementById('maintenance-count').textContent = metrics.maintenance_count || 0;
    }

    renderCharts(data) {
        this.renderStatusChart(data.statusDistribution);
        this.renderTypeChart(data.typeDistribution);
        this.renderProblemsChart(data.problemsByType);
        // Убрать: this.renderMonthlyTrendChart(data.monthly_stats);

        // Загружаем отдельно данные для графика затрат
        this.loadCostsChart();
    }

    renderStatusChart(distribution) {
        const ctx = document.getElementById('status-chart')?.getContext('2d');
        if (!ctx) return;

        if (this.charts.status) {
            this.charts.status.destroy();
        }

        const colors = getChartColors();

        this.charts.status = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: distribution.labels,
                datasets: [{
                    data: distribution.values,
                    backgroundColor: [
                        colors.excellent,
                        colors.good,
                        colors.satisfactory,
                        colors.needsCare,
                        colors.critical
                    ],
                    borderWidth: 1,
                    borderColor: document.body.classList.contains('dark-mode') ? '#333' : '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#333',
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    }

    renderTypeChart(distribution) {
        const ctx = document.getElementById('type-chart')?.getContext('2d');
        if (!ctx) return;

        if (this.charts.type) {
            this.charts.type.destroy();
        }

        const colors = getChartColors();

        this.charts.type = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: distribution.labels,
                datasets: [{
                    label: 'Количество зон',
                    data: distribution.values,
                    backgroundColor: colors.primary,
                    borderColor: colors.primary,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#666'
                        },
                        grid: {
                            color: document.body.classList.contains('dark-mode') ? '#444' : '#e0e0e0'
                        }
                    },
                    x: {
                        ticks: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#666'
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    renderProblemsChart(data) {
        const ctx = document.getElementById('problems-chart')?.getContext('2d');
        if (!ctx) return;

        if (this.charts.problems) {
            this.charts.problems.destroy();
        }

        const colors = getChartColors();
        const backgroundColors = [
            colors.blue,
            colors.purple,
            colors.gray,
            colors.needsCare,
            colors.critical,
            colors.accent
        ];

        this.charts.problems = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.values,
                    backgroundColor: backgroundColors.slice(0, data.labels.length),
                    borderWidth: 1,
                    borderColor: document.body.classList.contains('dark-mode') ? '#333' : '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#333',
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    }

    renderMonthlyTrendChart(monthlyStats) {
        const ctx = document.getElementById('dynamics-chart')?.getContext('2d');
        if (!ctx) return;

        if (this.charts.dynamics) {
            this.charts.dynamics.destroy();
        }

        const colors = getChartColors();

        const labels = monthlyStats.map(m => m.month);
        const zonesAdded = monthlyStats.map(m => m.zones_added);

        this.charts.dynamics = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Добавлено зон',
                        data: zonesAdded,
                        borderColor: colors.primary,
                        backgroundColor: colors.primary + '20',
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#333'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#666'
                        },
                        grid: {
                            color: document.body.classList.contains('dark-mode') ? '#444' : '#e0e0e0'
                        }
                    },
                    x: {
                        ticks: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#666'
                        },
                        grid: {
                            color: document.body.classList.contains('dark-mode') ? '#444' : '#e0e0e0'
                        }
                    }
                }
            }
        });
    }

    async loadCostsChart() {
        try {
            const response = await fetch(`/api/analytics/chart/maintenance-costs?city=${encodeURIComponent(this.currentCity)}`);
            if (!response.ok) throw new Error('Ошибка загрузки данных');

            const data = await response.json();
            this.renderCostsChart(data);
        } catch (error) {
            console.error('Ошибка загрузки графика затрат:', error);
        }
    }

    renderCostsChart(data) {
        const ctx = document.getElementById('costs-chart')?.getContext('2d');
        if (!ctx) return;

        if (this.charts.costs) {
            this.charts.costs.destroy();
        }

        const colors = getChartColors();

        this.charts.costs = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Затраты (тыс. руб)',
                    data: data.values,
                    backgroundColor: colors.primary,
                    borderColor: colors.primary,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#333'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#666',
                            callback: function(value) {
                                return value + ' тыс.';
                            }
                        },
                        grid: {
                            color: document.body.classList.contains('dark-mode') ? '#444' : '#e0e0e0'
                        }
                    },
                    x: {
                        ticks: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#666'
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    async loadPredictions() {
        try {
            const response = await fetch(`/api/analytics/predictions?city=${encodeURIComponent(this.currentCity)}`);
            if (!response.ok) throw new Error('Ошибка загрузки прогнозов');

            const data = await response.json();
            this.updatePredictions(data);
        } catch (error) {
            console.error('Ошибка загрузки прогнозов:', error);
            this.updatePredictions({
                status: { improve: 0, worsen: 0, stable: 0, recommendation: 'Данные временно недоступны' },
                budget: { monthly: 0, quarterly: 0, annual: 0, recommended: 0 },
                recommendations: ['Загрузка данных...']
            });
        }
    }

    updatePredictions(predictions) {
        // Прогноз состояния
        const statusPrediction = document.getElementById('status-prediction');
        if (statusPrediction && predictions.status) {
            statusPrediction.innerHTML = `
                <div class="prediction-item">
                    <strong>Улучшится:</strong> ${predictions.status.improve} зон
                </div>
                <div class="prediction-item">
                    <strong>Ухудшится:</strong> ${predictions.status.worsen} зон
                </div>
                <div class="prediction-item">
                    <strong>Останется прежним:</strong> ${predictions.status.stable} зон
                </div>
                <div class="prediction-summary">
                    <i class="fas fa-info-circle"></i>
                    ${predictions.status.recommendation}
                </div>
            `;
        }

        // Прогноз бюджета
        const budgetPrediction = document.getElementById('budget-prediction');
        if (budgetPrediction && predictions.budget) {
            budgetPrediction.innerHTML = `
                <div class="prediction-item">
                    <strong>Текущий месяц:</strong> ${Math.round(predictions.budget.monthly).toLocaleString('ru-RU')} руб.
                </div>
                <div class="prediction-item">
                    <strong>Квартал:</strong> ${Math.round(predictions.budget.quarterly).toLocaleString('ru-RU')} руб.
                </div>
                <div class="prediction-item">
                    <strong>Год:</strong> ${Math.round(predictions.budget.annual).toLocaleString('ru-RU')} руб.
                </div>
                <div class="prediction-item">
                    <strong>Рекомендуемый бюджет:</strong> ${Math.round(predictions.budget.recommended).toLocaleString('ru-RU')} руб.
                </div>
            `;
        }

        // Рекомендации
        const recommendations = document.getElementById('recommendations');
        if (recommendations && predictions.recommendations) {
            recommendations.innerHTML = predictions.recommendations.map(rec => `
                <div class="recommendation-item">
                    <i class="fas fa-check-circle"></i>
                    ${rec}
                </div>
            `).join('');
        }
    }

    async loadDetailedStats() {
        try {
            const response = await fetch(`/api/analytics/detailed?city=${encodeURIComponent(this.currentCity)}`);
            if (!response.ok) throw new Error('Ошибка загрузки детальной статистики');

            const data = await response.json();
            this.updateDetailedStats(data);
        } catch (error) {
            console.error('Ошибка загрузки детальной статистики:', error);
        }
    }

    updateDetailedStats(data) {
        // Обновляем таблицу зон
        const zonesStatsBody = document.getElementById('zones-stats-body');
        if (zonesStatsBody && data.zones) {
            zonesStatsBody.innerHTML = data.zones.map(zone => `
                <tr>
                    <td>${zone.type}</td>
                    <td>${zone.total}</td>
                    <td>${zone.excellent}</td>
                    <td>${zone.good}</td>
                    <td>${zone.satisfactory}</td>
                    <td>${zone.needs_care}</td>
                    <td>${zone.critical}</td>
                </tr>
            `).join('');
        }
    }

    updateChartsForTheme() {
        // Перерисовываем все графики при смене темы
        Object.keys(this.charts).forEach(chartName => {
            if (this.charts[chartName]) {
                this.charts[chartName].destroy();
                delete this.charts[chartName];
            }
        });

        // Перезагружаем данные
        this.loadAnalyticsData();
        this.loadCostsChart();
    }

    generateReport() {
        const report = {
            title: `Отчет ЭКОПУЛЬС - ${this.currentCity}`,
            date: new Date().toLocaleDateString('ru-RU'),
            city: this.currentCity,
            generatedAt: new Date().toISOString(),
            data: {}
        };

        // Собираем данные из DOM
        report.data = {
            totalZones: document.getElementById('total-zones').textContent,
            goodZones: document.getElementById('good-zones').textContent,
            problemZones: document.getElementById('problem-zones').textContent,
            activeProblems: document.getElementById('maintenance-count').textContent
        };

        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ecopulse_report_${this.currentCity}_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);

        this.showMessage('Отчет успешно скачан', 'success');
    }

    showMessage(text, type) {
        const message = document.createElement('div');
        message.className = `message message-${type}`;
        message.textContent = text;
        message.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background-color: ${type === 'error' ? '#f44336' : '#4caf50'};
            color: white;
            z-index: 3000;
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(message);

        setTimeout(() => {
            message.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => message.remove(), 300);
        }, 3000);
    }

    showError(text) {
        this.showMessage(text, 'error');
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Добавляем стили для темной темы графиков
    const style = document.createElement('style');
    style.textContent = `
        body.dark-mode .chart-card {
            background-color: #2d2d2d;
            color: #fff;
        }

        body.dark-mode .chart-header h3 {
            color: #fff;
        }

        body.dark-mode .prediction-card {
            background-color: #2d2d2d;
            color: #fff;
        }

        body.dark-mode .prediction-header {
            background: linear-gradient(135deg, #388e3c, #1b5e20);
        }

        body.dark-mode .stats-table {
            color: #fff;
        }

        body.dark-mode .stats-table th {
            background-color: #333;
            color: #fff;
        }

        body.dark-mode .stats-table td {
            border-color: #444;
        }

        body.dark-mode .stats-table tr:hover {
            background-color: #333;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    window.analyticsDashboard = new AnalyticsDashboard();
});
</script>

<style>
.analytics-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.analytics-header {
    margin-bottom: 2rem;
}

.analytics-header h1 {
    color: var(--primary-dark);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.analytics-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.analytics-controls select {
    padding: 0.75rem 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    min-width: 200px;
    color: var(--text-primary);
}

body.dark-mode .analytics-controls select {
    background-color: #333;
    border-color: #444;
    color: var(--text-primary);
}

/* Метрики */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

body.dark-mode .metric-card {
    background: #2d2d2d;
    color: #fff;
}

.metric-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.metric-icon i {
    font-size: 1.8rem;
}

.metric-content {
    flex: 1;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    line-height: 1;
}

body.dark-mode .metric-value {
    color: var(--primary-light);
}

.metric-label {
    color: var(--text-secondary);
    margin-top: 0.5rem;
    font-size: 0.9rem;
}

body.dark-mode .metric-label {
    color: #b0b0b0;
}

/* Графики */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 1.5rem;
}

.chart-card.full-width {
    grid-column: 1 / -1;
}

.chart-header {
    margin-bottom: 1.5rem;
}

.chart-header h3 {
    margin: 0;
    color: var(--primary-dark);
    font-size: 1.1rem;
}

.chart-container {
    height: 300px;
    position: relative;
}

/* Прогнозы */
.predictions-section {
    margin-bottom: 2rem;
}

.predictions-section h2 {
    color: var(--primary-dark);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

body.dark-mode .predictions-section h2 {
    color: #fff;
}

.predictions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.prediction-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.prediction-header {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.prediction-header i {
    font-size: 1.5rem;
}

.prediction-header h3 {
    margin: 0;
    font-size: 1.1rem;
}

.prediction-content {
    padding: 1.5rem;
}

.prediction-item {
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #eee;
}

body.dark-mode .prediction-item {
    border-bottom-color: #444;
}

.prediction-item:last-child {
    margin-bottom: 0;
    border-bottom: none;
}

.prediction-summary {
    margin-top: 1rem;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 6px;
    font-size: 0.9rem;
}

body.dark-mode .prediction-summary {
    background: #333;
    color: #fff;
}

.recommendation-item {
    margin-bottom: 0.75rem;
    padding: 0.5rem;
    background: #f5f5f5;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

body.dark-mode .recommendation-item {
    background: #333;
    color: #fff;
}

.recommendation-item i {
    color: #4caf50;
}

/* Детальная статистика */
.detailed-stats {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

body.dark-mode .detailed-stats {
    background: #2d2d2d;
    color: #fff;
}

.detailed-stats h2 {
    color: var(--primary-dark);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

body.dark-mode .detailed-stats h2 {
    color: #fff;
}

.stats-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 0.5rem;
}

body.dark-mode .stats-tabs {
    border-bottom-color: #444;
}

.stats-tab {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    color: var(--text-secondary);
    position: relative;
    transition: all 0.3s;
}

.stats-tab:hover {
    background: #f5f5f5;
    color: var(--primary-color);
}

body.dark-mode .stats-tab:hover {
    background: #333;
    color: var(--primary-light);
}

.stats-tab.active {
    color: var(--primary-color);
    font-weight: 600;
}

body.dark-mode .stats-tab.active {
    color: var(--primary-light);
}

.stats-tab.active:after {
    content: '';
    position: absolute;
    bottom: -0.5rem;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-color);
}

body.dark-mode .stats-tab.active:after {
    background: var(--primary-light);
}

.stats-content {
    display: none;
}

.stats-content.active {
    display: block;
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
}

.stats-table th {
    background: #f5f5f5;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid #e0e0e0;
}

.stats-table td {
    padding: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.stats-table tr:hover {
    background: #f9f9f9;
}

@media (max-width: 768px) {
    .analytics-container {
        padding: 1rem;
    }

    .analytics-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .analytics-controls select,
    .analytics-controls button {
        width: 100%;
    }

    .charts-grid {
        grid-template-columns: 1fr;
    }

    .chart-card {
        padding: 1rem;
    }

    .chart-container {
        height: 250px;
    }

    .metrics-grid {
        grid-template-columns: 1fr;
    }

    .predictions-grid {
        grid-template-columns: 1fr;
    }

    .stats-table {
        display: block;
        overflow-x: auto;
    }
}
</style>
{% endblock %}