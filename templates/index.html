{% extends "base.html" %}

{% block title %}ЭКОПУЛЬС {{ city }}{% endblock %}

{% block content %}

<div class="map-container">
    <div id="map"></div>

    <!-- Side Panel -->
    <div class="side-panel" id="side-panel">
        <div class="panel-header">
            <div class="panel-title-wrapper">
                <h3><i class="fas fa-map-marker-alt"></i> Зоны города {{ city }}</h3>
                <button class="toggle-panel-btn" onclick="toggleSidePanel()" title="Скрыть/показать панель">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        </div>

        <div class="panel-content">
            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <h4>Фильтр по статусу</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-status="all">Все</button>
                        {% for status, data in statuses.items() %}
                        <button class="filter-btn" data-status="{{ status }}">
                            {{ data.icon }} {{ status|capitalize }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-group">
                    <h4>Фильтр по типу</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-type="all">Все</button>
                        {% for type in zone_types %}
                        <button class="filter-btn" data-type="{{ type }}">
                            {{ type|capitalize }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="statistics">
                <h4>Статистика города</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-zones">0</div>
                        <div class="stat-label">Всего зон</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="good-zones">0</div>
                        <div class="stat-label">В хорошем состоянии</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="problem-zones">0</div>
                        <div class="stat-label">С проблемами</div>
                    </div>
                </div>
            </div>

            <!-- Кнопка для режима админа -->
            {% if user and user.role == 'admin' and request.args.get('admin_mode') == 'true' %}
            <div class="admin-mode-notice">
                <h4><i class="fas fa-crown"></i> Режим администратора</h4>
                <p>Кликните на карте, чтобы выбрать координаты для новой зоны.</p>
                <button class="btn btn-primary" onclick="saveSelectedLocation()">
                    <i class="fas fa-check"></i> Использовать выбранное местоположение
                </button>
                <button class="btn btn-outline" onclick="cancelLocationSelection()">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Legend (только для ПК) -->
    <div class="map-legend">
        <h4>Легенда</h4>
        {% for status, data in statuses.items() %}
        <div class="legend-item">
            <span class="legend-color" style="background-color: {{ data.color }}"></span>
            <span class="legend-label">{{ status|capitalize }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Analytics Modal -->
<div id="analytics-modal" class="modal modal-wide">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="chart-title">Аналитика</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <canvas id="analytics-chart"></canvas>
        </div>
    </div>
</div>

<script>
// Передаем данные в глобальную область видимости для JavaScript
window.citiesData = {{ cities|tojson }};
window.statuses = {{ statuses|tojson }};
window.zoneTypes = {{ zone_types|tojson }};
window.isAdminMode = {{ 'true' if (user and user.role == 'admin' and request.args.get('admin_mode') == 'true') else 'false' }};
</script>

<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}